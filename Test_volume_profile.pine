// @version=6
indicator("Session Volume Profile", overlay=true, max_labels_count=500)

// Input parameters
numRows = input.int(20, "Number of Profile Rows", minval=2, maxval=100)
profileWidth = input.float(0.75, "Profile Width", minval=0.1, maxval=2.0, step=0.1)
transparency = input.int(70, "Profile Transparency", minval=0, maxval=100)
showPOC = input.bool(true, "Show POC Line")
pocWidth = input.int(3, "POC Line Width", minval=1, maxval=10)
pocColor = input.color(color.yellow, "POC Color")
asianColor = input.color(color.blue, "Asian Session Color")
europeanColor = input.color(color.green, "European Session Color")
americanColor = input.color(color.red, "American Session Color")
showYesterday = input.bool(true, "Show Yesterday's Sessions")
yesterdayTransparency = input.int(85, "Yesterday Transparency", minval=0, maxval=100)
showVA = input.bool(true, "Show Value Area Lines")
VAwid = input.int(70, "Value Area Volume %", minval=1, maxval=100)
dispMode = input.string('Mode 2', 'Bar Mode', ['Mode 1', 'Mode 2', 'Mode 3'])
volType = input.string('Volume', 'Profile Data Type', options=['Volume', 'Open Interest'])
smoothVol = input.bool(false, 'Smooth Volume Data', tooltip='Helps create better profiles for assets with large volume spikes')

// Session times (in UTC)
asianSessionStart = 0     // 00:00 UTC
asianSessionEnd = 8       // 08:00 UTC
europeanSessionStart = 8  // 08:00 UTC
europeanSessionEnd = 16   // 16:00 UTC
americanSessionStart = 14 // 14:00 UTC
americanSessionEnd = 22   // 22:00 UTC

// Structure to store session data
type SessionData
    float high
    float low
    float pocLevel
    int pocVolume
    int[] volumeArray
    int[] greenVolumeArray
    int[] redVolumeArray
    string sessionType
    int startBar
    int endBar

// Initialize session data arrays
var SessionData asianToday = SessionData.new(0.0, 0.0, 0.0, 0, array.new_int(numRows, 0), array.new_int(numRows, 0), array.new_int(numRows, 0), "Asian", 0, 0)
var SessionData europeanToday = SessionData.new(0.0, 0.0, 0.0, 0, array.new_int(numRows, 0), array.new_int(numRows, 0), array.new_int(numRows, 0), "European", 0, 0)
var SessionData americanToday = SessionData.new(0.0, 0.0, 0.0, 0, array.new_int(numRows, 0), array.new_int(numRows, 0), array.new_int(numRows, 0), "American", 0, 0)
var SessionData asianYesterday = SessionData.new(0.0, 0.0, 0.0, 0, array.new_int(numRows, 0), array.new_int(numRows, 0), array.new_int(numRows, 0), "Asian", 0, 0)
var SessionData europeanYesterday = SessionData.new(0.0, 0.0, 0.0, 0, array.new_int(numRows, 0), array.new_int(numRows, 0), array.new_int(numRows, 0), "European", 0, 0)
var SessionData americanYesterday = SessionData.new(0.0, 0.0, 0.0, 0, array.new_int(numRows, 0), array.new_int(numRows, 0), array.new_int(numRows, 0), "American", 0, 0)

// Track current day
var int currentDay = dayofmonth(time)
var int currentMonth = month(time)
var int currentYear = year(time)

// Function to check if today is a new day
isDayStart() => dayofmonth(time) != currentDay or month(time) != currentMonth or year(time) != currentYear

// Current session tracking
var string currentSession = "None"
var bool asianStarted = false
var bool europeanStarted = false
var bool americanStarted = false

// Function to determine the current market session
getCurrentSession() =>
    int currentHour = hour(time)
    if currentHour >= asianSessionStart and currentHour < asianSessionEnd
        "Asian"
    else if currentHour >= europeanSessionStart and currentHour < europeanSessionEnd
        "European"
    else if currentHour >= americanSessionStart and currentHour < americanSessionEnd
        "American"
    else
        "None"

// Check for session changes
newSession = getCurrentSession()
if newSession != currentSession
    // Record start bar for new session
    if newSession == "Asian" and not asianStarted
        asianToday.startBar := bar_index
        asianStarted := true
    else if newSession == "European" and not europeanStarted
        europeanToday.startBar := bar_index
        europeanStarted := true
    else if newSession == "American" and not americanStarted
        americanToday.startBar := bar_index
        americanStarted := true
    
    // Record end bar for ending session
    if currentSession == "Asian" and newSession != "Asian"
        asianToday.endBar := bar_index - 1
    else if currentSession == "European" and newSession != "European"
        europeanToday.endBar := bar_index - 1
    else if currentSession == "American" and newSession != "American"
        americanToday.endBar := bar_index - 1
    
    currentSession := newSession

// Check for day change
bool isNewDay = isDayStart()
if isNewDay
    currentDay := dayofmonth(time)
    currentMonth := month(time)
    currentYear := year(time)
    
    // Move today's data to yesterday
    asianYesterday := asianToday
    europeanYesterday := europeanToday
    americanYesterday := americanToday
    
    // Reset today's data
    asianToday := SessionData.new(0.0, 0.0, 0.0, 0, array.new_int(numRows, 0), array.new_int(numRows, 0), array.new_int(numRows, 0), "Asian", 0, 0)
    europeanToday := SessionData.new(0.0, 0.0, 0.0, 0, array.new_int(numRows, 0), array.new_int(numRows, 0), array.new_int(numRows, 0), "European", 0, 0)
    americanToday := SessionData.new(0.0, 0.0, 0.0, 0, array.new_int(numRows, 0), array.new_int(numRows, 0), array.new_int(numRows, 0), "American", 0, 0)
    
    // Reset session flags
    asianStarted := false
    europeanStarted := false
    americanStarted := false

// Function to get session color
getSessionColor(string session) =>
    if session == "Asian"
        asianColor
    else if session == "European"
        europeanColor
    else if session == "American"
        americanColor
    else
        color.blue

// Function to check if we're in a specific session
isInCurrentSession(string sessionName) => getCurrentSession() == sessionName

// Function to get the current session data
getSessionData(string sessionName, bool isToday) =>
    if isToday
        if sessionName == "Asian"
            asianToday
        else if sessionName == "European"
            europeanToday
        else if sessionName == "American"
            americanToday
        else
            na
    else
        if sessionName == "Asian"
            asianYesterday
        else if sessionName == "European"
            europeanYesterday
        else if sessionName == "American"
            americanYesterday
        else
            na

// Enhanced volume function from VolumeProfile.pine
vol() => smoothVol ? ta.ema(volume, 5) : volume

// Get volume for specific price zone - adapted from VolumeProfile.pine
get_vol(y11, y12, y21, y22, height, vol) => nz(math.max(math.min(math.max(y11, y12), math.max(y21, y22)) - math.max(math.min(y11, y12), math.min(y21, y22)), 0) * vol / height)

// Process data for current session only with enhanced volume profile
processCurrentSession() =>
    sessionName = getCurrentSession()
    if sessionName != "None"
        SessionData sessionData = getSessionData(sessionName, true)
        
        // Update high/low
        if sessionData.high == 0.0 or high > sessionData.high
            if sessionName == "Asian"
                asianToday.high := high
            else if sessionName == "European"
                europeanToday.high := high
            else if sessionName == "American"
                americanToday.high := high
        
        if sessionData.low == 0.0 or low < sessionData.low
            if sessionName == "Asian"
                asianToday.low := low
            else if sessionName == "European"
                europeanToday.low := low
            else if sessionName == "American"
                americanToday.low := low
        
        // Update session data with improved volume profile
        sessionHigh = sessionData.high
        sessionLow = sessionData.low
        
        if sessionHigh > sessionLow
            gap = (sessionHigh - sessionLow) / numRows
            
            // Using enhanced volume profile distribution from VolumeProfile.pine
            body_top = math.max(close, open)
            body_bot = math.min(close, open)
            itsgreen = close >= open
            
            topwick = high - body_top
            bottomwick = body_bot - low
            body = body_top - body_bot
            
            bodyvol = body * vol() / (2 * topwick + 2 * bottomwick + body)
            topwickvol = 2 * topwick * vol() / (2 * topwick + 2 * bottomwick + body)
            bottomwickvol = 2 * bottomwick * vol() / (2 * topwick + 2 * bottomwick + body)
            
            // Going over each zone
            for i = 0 to numRows - 1
                zoneTop = sessionHigh - gap * i
                zoneBot = zoneTop - gap
                
                // Calculate green and red volume distribution
                greenVol = (itsgreen ? get_vol(zoneBot, zoneTop, body_bot, body_top, body, bodyvol) : 0) + 
                           get_vol(zoneBot, zoneTop, body_top, high, topwick, topwickvol) / 2 + 
                           get_vol(zoneBot, zoneTop, body_bot, low, bottomwick, bottomwickvol) / 2
                           
                redVol = (itsgreen ? 0 : get_vol(zoneBot, zoneTop, body_bot, body_top, body, bodyvol)) + 
                         get_vol(zoneBot, zoneTop, body_top, high, topwick, topwickvol) / 2 + 
                         get_vol(zoneBot, zoneTop, body_bot, low, bottomwick, bottomwickvol) / 2
                
                // Update volumes in arrays
                if sessionName == "Asian"
                    array.set(asianToday.greenVolumeArray, i, array.get(asianToday.greenVolumeArray, i) + int(greenVol))
                    array.set(asianToday.redVolumeArray, i, array.get(asianToday.redVolumeArray, i) + int(redVol))
                    array.set(asianToday.volumeArray, i, array.get(asianToday.volumeArray, i) + int(greenVol + redVol))
                    if array.get(asianToday.volumeArray, i) > asianToday.pocVolume
                        asianToday.pocVolume := array.get(asianToday.volumeArray, i)
                        asianToday.pocLevel := zoneBot + gap / 2
                else if sessionName == "European"
                    array.set(europeanToday.greenVolumeArray, i, array.get(europeanToday.greenVolumeArray, i) + int(greenVol))
                    array.set(europeanToday.redVolumeArray, i, array.get(europeanToday.redVolumeArray, i) + int(redVol))
                    array.set(europeanToday.volumeArray, i, array.get(europeanToday.volumeArray, i) + int(greenVol + redVol))
                    if array.get(europeanToday.volumeArray, i) > europeanToday.pocVolume
                        europeanToday.pocVolume := array.get(europeanToday.volumeArray, i)
                        europeanToday.pocLevel := zoneBot + gap / 2
                else if sessionName == "American"
                    array.set(americanToday.greenVolumeArray, i, array.get(americanToday.greenVolumeArray, i) + int(greenVol))
                    array.set(americanToday.redVolumeArray, i, array.get(americanToday.redVolumeArray, i) + int(redVol))
                    array.set(americanToday.volumeArray, i, array.get(americanToday.volumeArray, i) + int(greenVol + redVol))
                    if array.get(americanToday.volumeArray, i) > americanToday.pocVolume
                        americanToday.pocVolume := array.get(americanToday.volumeArray, i)
                        americanToday.pocLevel := zoneBot + gap / 2

// Process current session
processCurrentSession()

// Value Area calculation - adapted from VolumeProfile.pine
valueLevels(SessionData sessionData) =>
    float gap = (sessionData.high - sessionData.low) / numRows
    float volSum = array.sum(sessionData.volumeArray)
    float volCnt = 0
    float vah = sessionData.high
    float val = sessionData.low
    
    // Finding poc index
    int pocInd = 0
    for i = 0 to numRows - 1
        if array.get(sessionData.volumeArray, i) == sessionData.pocVolume
            pocInd := i
            break
    
    volCnt += array.get(sessionData.volumeArray, pocInd)
    for i = 1 to numRows
        if pocInd + i >= 0 and pocInd + i < numRows
            volCnt += array.get(sessionData.volumeArray, pocInd + i)
            if volCnt >= volSum * (VAwid/100)
                break 
            else
                val := sessionData.low + (pocInd + i) * gap
        if pocInd - i >= 0 and pocInd - i < numRows
            volCnt += array.get(sessionData.volumeArray, pocInd - i)
            if volCnt >= volSum * (VAwid/100)
                break 
            else
                vah := sessionData.high - (pocInd - i) * gap
    
    [val, vah]

// Function to draw profile for a session with enhanced visualization
drawProfile(SessionData sessionData, bool isYesterday) =>
    if sessionData.high > sessionData.low and (sessionData.startBar > 0 or isYesterday)
        // Calculate value area levels
        [val, vah] = valueLevels(sessionData)
        
        // Get max volume for scaling
        maxVolume = math.max(array.max(sessionData.greenVolumeArray), array.max(sessionData.redVolumeArray))
        
        if maxVolume > 0
            // Calculate start and width based on session
            int profileStart = isYesterday ? bar_index : sessionData.startBar
            int profileWidth = int(5 * profileWidth)
            
            // Get session color and adjust transparency
            color sessionColor = getSessionColor(sessionData.sessionType)
            int useTransparency = isYesterday ? yesterdayTransparency : transparency
            
            // Calculate price per ray
            float pricePerRay = (sessionData.high - sessionData.low) / numRows
            
            // Draw volume bars with enhanced visualization
            for i = 0 to numRows - 1
                price = sessionData.low + i * pricePerRay
                greenVol = array.get(sessionData.greenVolumeArray, i)
                redVol = array.get(sessionData.redVolumeArray, i)
                
                // Calculate normalized widths based on volume
                greenWidth = int((greenVol / maxVolume) * profileWidth)
                redWidth = int((redVol / maxVolume) * profileWidth)
                
                // Display based on selected mode
                if dispMode == 'Mode 2'
                    // Draw green and red volumes side by side
                    if greenVol > 0
                        box.new(left=profileStart, right=profileStart + greenWidth, 
                                top=price + pricePerRay, bottom=price, 
                                bgcolor=color.new(color.green, useTransparency), 
                                border_color=color.new(color.green, useTransparency - 10), 
                                border_width=1, xloc=xloc.bar_index)
                    if redVol > 0
                        box.new(left=profileStart + greenWidth, right=profileStart + greenWidth + redWidth, 
                                top=price + pricePerRay, bottom=price, 
                                bgcolor=color.new(color.red, useTransparency), 
                                border_color=color.new(color.red, useTransparency - 10), 
                                border_width=1, xloc=xloc.bar_index)
                else if dispMode == 'Mode 1'
                    // Draw total volume as session color
                    totalWidth = greenWidth + redWidth
                    if totalWidth > 0
                        box.new(left=profileStart, right=profileStart + totalWidth, 
                                top=price + pricePerRay, bottom=price, 
                                bgcolor=color.new(sessionColor, useTransparency), 
                                border_color=color.new(sessionColor, useTransparency - 10), 
                                border_width=1, xloc=xloc.bar_index)
                else if dispMode == 'Mode 3'
                    // Draw green and red volumes on opposite sides
                    if greenVol > 0
                        box.new(left=profileStart, right=profileStart + greenWidth, 
                                top=price + pricePerRay, bottom=price, 
                                bgcolor=color.new(color.green, useTransparency), 
                                border_color=color.new(color.green, useTransparency - 10), 
                                border_width=1, xloc=xloc.bar_index)
                    if redVol > 0
                        box.new(left=profileStart - redWidth, right=profileStart, 
                                top=price + pricePerRay, bottom=price, 
                                bgcolor=color.new(color.red, useTransparency), 
                                border_color=color.new(color.red, useTransparency - 10), 
                                border_width=1, xloc=xloc.bar_index)
            
            // Draw POC line
            if showPOC and sessionData.pocVolume > 0
                line.new(x1=profileStart - (dispMode == 'Mode 3' ? profileWidth : 0), 
                         x2=profileStart + profileWidth, 
                         y1=sessionData.pocLevel, y2=sessionData.pocLevel, 
                         color=color.new(pocColor, useTransparency - 20), 
                         width=pocWidth, xloc=xloc.bar_index)
            
            // Draw value area lines
            if showVA
                line.new(x1=profileStart - (dispMode == 'Mode 3' ? profileWidth : 0), 
                         x2=profileStart + profileWidth, 
                         y1=vah, y2=vah, 
                         color=color.new(pocColor, useTransparency), 
                         width=1, xloc=xloc.bar_index)
                         
                line.new(x1=profileStart - (dispMode == 'Mode 3' ? profileWidth : 0), 
                         x2=profileStart + profileWidth, 
                         y1=val, y2=val, 
                         color=color.new(pocColor, useTransparency), 
                         width=1, xloc=xloc.bar_index)
            
            // Return true if profile was drawn
            true
        else
            false
    else
        false

// Draw profiles
if barstate.islast
    // Draw today's profiles for sessions that have started
    if asianStarted
        drawProfile(asianToday, false)
    
    if europeanStarted
        drawProfile(europeanToday, false)
    
    if americanStarted
        drawProfile(americanToday, false)
    
    // Draw yesterday's profiles if enabled
    if showYesterday
        if asianYesterday.high > 0 and asianYesterday.low > 0
            drawProfile(asianYesterday, true)
        
        if europeanYesterday.high > 0 and europeanYesterday.low > 0
            drawProfile(europeanYesterday, true)
        
        if americanYesterday.high > 0 and americanYesterday.low > 0
            drawProfile(americanYesterday, true)
    
    // Display session info
    var label todayLabel = na
    var label yesterdayLabel = na
    
    if not na(todayLabel)
        label.delete(todayLabel)
    
    // Create today session text only for started sessions
    string todayText = "Today Sessions\n"
    if asianStarted
        todayText += "Asian: " + str.tostring(asianToday.pocLevel, "#.##") + "\n"
    if europeanStarted
        todayText += "European: " + str.tostring(europeanToday.pocLevel, "#.##") + "\n"
    if americanStarted
        todayText += "American: " + str.tostring(americanToday.pocLevel, "#.##")
    
    // Only create label if we have at least one session
    if todayText != "Today Sessions\n"
        todayLabel := label.new(bar_index + 5, math.max(asianToday.high, math.max(europeanToday.high, americanToday.high)), text=todayText, style=label.style_label_down, color=color.new(color.gray, 90), textcolor=color.white, xloc=xloc.bar_index)
    
    if showYesterday
        if not na(yesterdayLabel)
            label.delete(yesterdayLabel)
        
        string yesterdayText = "Yesterday Sessions\n"
        if asianYesterday.high > 0
            yesterdayText += "Asian: " + str.tostring(asianYesterday.pocLevel, "#.##") + "\n"
        if europeanYesterday.high > 0
            yesterdayText += "European: " + str.tostring(europeanYesterday.pocLevel, "#.##") + "\n"
        if americanYesterday.high > 0
            yesterdayText += "American: " + str.tostring(americanYesterday.pocLevel, "#.##")
        
        if yesterdayText != "Yesterday Sessions\n"
            yesterdayLabel := label.new(bar_index + 15, math.max(asianYesterday.high, math.max(europeanYesterday.high, americanYesterday.high)), text=yesterdayText, style=label.style_label_down, color=color.new(color.gray, 90), textcolor=color.white, xloc=xloc.bar_index)
