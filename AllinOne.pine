//@version=6
indicator("Xác định Đỉnh/Đáy", overlay=true, max_lines_count=500, max_labels_count=500)

// === INPUTS ===
leftBars = input.int(5, "Số nến bên trái", minval=1, tooltip="Số nến bên trái để xác nhận đỉnh/đáy")
rightBars = input.int(5, "Số nến bên phải", minval=1, tooltip="Số nến bên phải để xác nhận đỉnh/đáy")
showLabels = input.bool(true, "Hiển thị nhãn")
showLines = input.bool(true, "Hiển thị đường nối")
highColor = input.color(color.red, "Màu đỉnh")
lowColor = input.color(color.green, "Màu đáy")

// === FOREX SESSION INPUTS ===
showForexSessions = input.bool(true, "Hiển thị phiên Forex", group="Forex Sessions")
showAsianSession = input.bool(true, "Hiển thị phiên Á", group="Forex Sessions")
asianColor = input.color(color.new(color.yellow, 90), "Màu phiên Á", group="Forex Sessions")
showLondonSession = input.bool(true, "Hiển thị phiên London", group="Forex Sessions")
londonColor = input.color(color.new(color.blue, 90), "Màu phiên London", group="Forex Sessions")
showNYSession = input.bool(true, "Hiển thị phiên Mỹ", group="Forex Sessions")
nyColor = input.color(color.new(color.orange, 90), "Màu phiên Mỹ", group="Forex Sessions")

// === FOREX SESSION LOGIC ===
// Định nghĩa thời gian các phiên Forex (GMT)
// Phiên Á (Tokyo): 00:00 - 09:00 GMT
// Phiên London: 08:00 - 17:00 GMT
// Phiên Mỹ (New York): 13:00 - 22:00 GMT

asianSession = (hour(time, "GMT") >= 0 and hour(time, "GMT") < 9)
londonSession = (hour(time, "GMT") >= 8 and hour(time, "GMT") < 17)
nySession = (hour(time, "GMT") >= 13 and hour(time, "GMT") < 22)

// Biến theo dõi phiên Á
var bool wasAsianSession = false
var int asianStartBar = na
var float asianHigh = na
var float asianLow = na

// Biến theo dõi phiên London
var bool wasLondonSession = false
var int londonStartBar = na
var float londonHigh = na
var float londonLow = na

// Biến theo dõi phiên Mỹ
var bool wasNYSession = false
var int nyStartBar = na
var float nyHigh = na
var float nyLow = na

// Logic cho phiên Á
if showForexSessions and showAsianSession
    if asianSession and not wasAsianSession
        // Phiên mới bắt đầu
        asianStartBar := bar_index
        asianHigh := high
        asianLow := low
    else if asianSession
        // Đang trong phiên, cập nhật high/low
        asianHigh := math.max(asianHigh, high)
        asianLow := math.min(asianLow, low)
    else if not asianSession and wasAsianSession
        // Phiên vừa kết thúc, vẽ box
        box.new(asianStartBar, asianHigh, bar_index, asianLow,
                border_color=color.new(color.yellow, 50),
                bgcolor=asianColor,
                text="Asian",
                text_color=color.new(color.yellow, 0),
                text_size=size.small)
    wasAsianSession := asianSession

// Logic cho phiên London
if showForexSessions and showLondonSession
    if londonSession and not wasLondonSession
        // Phiên mới bắt đầu
        londonStartBar := bar_index
        londonHigh := high
        londonLow := low
    else if londonSession
        // Đang trong phiên, cập nhật high/low
        londonHigh := math.max(londonHigh, high)
        londonLow := math.min(londonLow, low)
    else if not londonSession and wasLondonSession
        // Phiên vừa kết thúc, vẽ box
        box.new(londonStartBar, londonHigh, bar_index, londonLow,
                border_color=color.new(color.blue, 50),
                bgcolor=londonColor,
                text="London",
                text_color=color.new(color.blue, 0),
                text_size=size.small)
    wasLondonSession := londonSession

// Logic cho phiên Mỹ
if showForexSessions and showNYSession
    if nySession and not wasNYSession
        // Phiên mới bắt đầu
        nyStartBar := bar_index
        nyHigh := high
        nyLow := low
    else if nySession
        // Đang trong phiên, cập nhật high/low
        nyHigh := math.max(nyHigh, high)
        nyLow := math.min(nyLow, low)
    else if not nySession and wasNYSession
        // Phiên vừa kết thúc, vẽ box
        box.new(nyStartBar, nyHigh, bar_index, nyLow,
                border_color=color.new(color.orange, 50),
                bgcolor=nyColor,
                text="NY",
                text_color=color.new(color.orange, 0),
                text_size=size.small)
    wasNYSession := nySession

// === PHÁT HIỆN ĐỈNH/ĐÁY ===
// Sử dụng hàm ta.pivothigh và ta.pivotlow
pivotHigh = ta.pivothigh(high, leftBars, rightBars)
pivotLow = ta.pivotlow(low, leftBars, rightBars)

// === VẼ NHÃN ===
if showLabels and not na(pivotHigh)
    label.new(
         bar_index[rightBars], 
         pivotHigh, 
         "Đỉnh\n" + str.tostring(pivotHigh, format.mintick),
         style=label.style_label_down,
         color=highColor,
         textcolor=color.white,
         size=size.small
         )

if showLabels and not na(pivotLow)
    label.new(
         bar_index[rightBars], 
         pivotLow, 
         "Đáy\n" + str.tostring(pivotLow, format.mintick),
         style=label.style_label_up,
         color=lowColor,
         textcolor=color.white,
         size=size.small
         )

// === VẼ ĐƯỜNG NỐI CÁC ĐỈNH/ĐÁY ===
var line lastHighLine = na
var line lastLowLine = na
var float lastHighPrice = na
var int lastHighIndex = na
var float lastLowPrice = na
var int lastLowIndex = na

if showLines and not na(pivotHigh)
    if not na(lastHighPrice)
        lastHighLine := line.new(
             lastHighIndex, lastHighPrice,
             bar_index[rightBars], pivotHigh,
             color=highColor,
             width=1,
             style=line.style_dashed
             )
    lastHighPrice := pivotHigh
    lastHighIndex := bar_index[rightBars]

if showLines and not na(pivotLow)
    if not na(lastLowPrice)
        lastLowLine := line.new(
             lastLowIndex, lastLowPrice,
             bar_index[rightBars], pivotLow,
             color=lowColor,
             width=1,
             style=line.style_dashed
             )
    lastLowPrice := pivotLow
    lastLowIndex := bar_index[rightBars]

// === PLOT MARKERS ===
plotshape(pivotHigh, "Đỉnh", shape.triangledown, location.abovebar, highColor, offset=-rightBars, size=size.tiny)
plotshape(pivotLow, "Đáy", shape.triangleup, location.belowbar, lowColor, offset=-rightBars, size=size.tiny)

// === HIỂN THỊ THÔNG TIN ===
var table infoTable = table.new(position.top_right, 2, 3, bgcolor=color.new(color.gray, 80))

if barstate.islast
    table.cell(infoTable, 0, 0, "Đỉnh gần nhất:", text_color=color.white, text_halign=text.align_left)
    table.cell(infoTable, 1, 0, str.tostring(lastHighPrice, format.mintick), text_color=highColor, text_halign=text.align_right)
    table.cell(infoTable, 0, 1, "Đáy gần nhất:", text_color=color.white, text_halign=text.align_left)
    table.cell(infoTable, 1, 1, str.tostring(lastLowPrice, format.mintick), text_color=lowColor, text_halign=text.align_right)
    table.cell(infoTable, 0, 2, "Cài đặt:", text_color=color.white, text_halign=text.align_left)
    table.cell(infoTable, 1, 2, str.tostring(leftBars) + "/" + str.tostring(rightBars), text_color=color.white, text_halign=text.align_right)
