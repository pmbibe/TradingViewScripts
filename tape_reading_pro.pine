// This Pine Scriptâ„¢ code is subject to the terms of the Mozilla Public License 2.0 at https://mozilla.org/MPL/2.0/
// Â© pmbibe

//@version=6
indicator("Tape Reading Pro - Order Flow Analysis", shorttitle="TapeReadingPro", overlay=true, max_bars_back=500, max_labels_count=500)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TAPE READING FOUNDATIONS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// This indicator decodes institutional order flow by analyzing:
// 1. PRICE: Movement direction, speed, and tick behavior
// 2. VOLUME: Traded volume, spikes, and absorption patterns
// 3. TIME: Duration at price levels and consolidation periods
//
// Key Tape Behaviors Detected:
// - Aggressive Buying/Selling (Initiative Orders)
// - Absorption (Smart Money Accumulation/Distribution)
// - Exhaustion (Climax Volume & Reversals)
// - Initiative vs Responsive Orders
// - Fake vs Real Breakouts

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// USER INPUTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// === MODULE TOGGLES ===
group_modules = "â•â•â• MODULE TOGGLES â•â•â•"
show_aggressive = input.bool(true, "Show Aggressive Orders", group=group_modules, tooltip="Detect initiative buying/selling with fast price movement and high volume")
show_absorption = input.bool(true, "Show Absorption Zones", group=group_modules, tooltip="Identify areas where Smart Money is accumulating/distributing (high volume, minimal price movement)")
show_exhaustion = input.bool(true, "Show Exhaustion Signals", group=group_modules, tooltip="Detect climax volume followed by reversals")
show_delta_histogram = input.bool(true, "Show Volume Delta Histogram", group=group_modules, tooltip="Display estimated buying/selling pressure")
show_labels = input.bool(true, "Show Event Labels", group=group_modules, tooltip="Display labels for key tape reading events")
show_candle_colors = input.bool(false, "Color Candles by Tape Condition", group=group_modules, tooltip="Override candle colors based on order flow (disabled by default for cleaner chart)")

// === VOLUME PARAMETERS ===
group_volume = "â•â•â• VOLUME PARAMETERS â•â•â•"
volume_ma_length = input.int(20, "Volume MA Length", minval=5, maxval=100, group=group_volume, tooltip="Period for average volume calculation")
high_volume_threshold = input.float(2.0, "High Volume Threshold", minval=1.0, maxval=5.0, step=0.1, group=group_volume, tooltip="Multiplier of average volume to detect high volume (2.0 = 200% of average)")
extreme_volume_threshold = input.float(3.0, "Extreme Volume Threshold", minval=2.0, maxval=10.0, step=0.5, group=group_volume, tooltip="Multiplier for exhaustion detection (3.0 = 300% of average)")

// === ABSORPTION PARAMETERS ===
group_absorption = "â•â•â• ABSORPTION PARAMETERS â•â•â•"
absorption_sensitivity = input.float(1.5, "Absorption Sensitivity", minval=0.5, maxval=5.0, step=0.1, group=group_absorption, tooltip="Higher values = stricter absorption detection. Measures volume/spread ratio.")
absorption_lookback = input.int(3, "Absorption Lookback", minval=1, maxval=10, group=group_absorption, tooltip="Number of bars to confirm absorption pattern")

// === INITIATIVE PARAMETERS ===
group_initiative = "â•â•â• INITIATIVE PARAMETERS â•â•â•"
initiative_threshold = input.float(1.5, "Initiative Score Threshold", minval=1.0, maxval=3.0, step=0.1, group=group_initiative, tooltip="Minimum score to flag aggressive orders (combines body strength with volume)")
velocity_lookback = input.int(5, "Price Velocity Lookback", minval=3, maxval=20, group=group_initiative, tooltip="Period to measure price movement speed")

// === EXHAUSTION PARAMETERS ===
group_exhaustion = "â•â•â• EXHAUSTION PARAMETERS â•â•â•"
exhaustion_reversal_bars = input.int(3, "Exhaustion Reversal Bars", minval=1, maxval=5, group=group_exhaustion, tooltip="Number of reversal bars after climax volume to confirm exhaustion")

// === VISUAL SETTINGS ===
group_visual = "â•â•â• VISUAL SETTINGS â•â•â•"

// Display Mode
signal_display_mode = input.string("Shapes Only", "Signal Display Mode", options=["Labels Only", "Shapes Only", "Both", "None"], group=group_visual, tooltip="Choose how to display signals on chart")
show_backgrounds = input.bool(false, "Show Background Highlights", group=group_visual, tooltip="Highlight absorption zones (98% transparency)")
show_metrics_table = input.bool(false, "Show Metrics Table", group=group_visual, tooltip="Display compact metrics (top-right corner)")

// Histogram Settings
histogram_scale = input.float(0.35, "Histogram Scale", minval=0.1, maxval=1.0, step=0.05, group=group_visual, tooltip="Scale down histogram size (0.35 = 35% of full scale)")
histogram_transparency = input.int(75, "Histogram Transparency", minval=0, maxval=95, step=5, group=group_visual, tooltip="Higher = more transparent (75 recommended)")
show_histogram_sma = input.bool(true, "Show Histogram SMA", group=group_visual, tooltip="Overlay trend line on delta histogram")
histogram_sma_length = input.int(10, "Histogram SMA Length", minval=3, maxval=50, group=group_visual, tooltip="Period for histogram trend line")

// Signal Colors (optimized contrast)
color_aggressive_buy = input.color(color.new(#00ff00, 0), "Aggressive Buy", group=group_visual)
color_aggressive_sell = input.color(color.new(#ff0000, 0), "Aggressive Sell", group=group_visual)
color_absorption = input.color(color.new(#2196F3, 0), "Absorption", group=group_visual)
color_exhaustion = input.color(color.new(#ff9800, 0), "Exhaustion", group=group_visual)
color_delta_buy = input.color(color.new(#00ff00, 0), "Delta Buy", group=group_visual)
color_delta_sell = input.color(color.new(#ff1744, 0), "Delta Sell", group=group_visual)
color_histogram_sma = input.color(color.new(color.yellow, 0), "Histogram SMA", group=group_visual)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CORE TAPE READING CALCULATIONS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// === BASIC METRICS ===
candle_body = math.abs(close - open)
candle_range = high - low
candle_direction = close >= open ? 1 : -1

// Avoid division by zero
candle_range_safe = candle_range == 0 ? 0.0000001 : candle_range

// === VOLUME ANALYSIS ===
volume_ma = ta.sma(volume, volume_ma_length)
volume_ratio = volume_ma == 0 ? 0 : volume / volume_ma

// === VOLUME DELTA ESTIMATION ===
// Since TradingView doesn't have real delta, we estimate it using close position within candle
// Bullish candle closing near high = buying pressure
// Bearish candle closing near low = selling pressure
close_position = (close - low) / candle_range_safe  // 0 to 1, where 1 = close at high
delta_estimate = (close_position - 0.5) * 2 * volume  // -volume to +volume
// Alternative: simple delta based on candle direction
delta_simple = candle_direction * volume

// Combine both methods with weight toward close position
volume_delta = (delta_estimate * 0.7) + (delta_simple * 0.3)

// === PRICE VELOCITY ===
// Measures how fast price is moving (initiative orders move price quickly)
price_change = math.abs(close - close[velocity_lookback])
price_velocity = price_change / velocity_lookback

// === ABSORPTION RATIO ===
// High volume with minimal price movement = absorption
// Formula: Volume / (High - Low)
// Higher ratio = more absorption (lots of volume but price not moving)
absorption_ratio = volume / candle_range_safe

// Normalize absorption ratio by comparing to recent average
absorption_ratio_ma = ta.sma(absorption_ratio, absorption_lookback)
absorption_normalized = absorption_ratio_ma == 0 ? 0 : absorption_ratio / absorption_ratio_ma

// === INITIATIVE SCORE ===
// Combines candle body strength with volume to detect aggressive orders
// Strong body + high volume = initiative orders
body_strength = candle_body / candle_range_safe  // Wicks indicate responsive orders, body indicates initiative
initiative_score = body_strength * volume_ratio

// === EXHAUSTION DETECTION ===
// Extreme volume followed by reversal = exhaustion
is_extreme_volume = volume_ratio >= extreme_volume_threshold

// Check if next bars reverse (for exhaustion confirmation)
// Note: This uses future data for confirmation, but clearly marked as such
is_bullish_exhaustion = is_extreme_volume and candle_direction == 1 and ta.falling(close, exhaustion_reversal_bars)
is_bearish_exhaustion = is_extreme_volume and candle_direction == -1 and ta.rising(close, exhaustion_reversal_bars)
is_exhaustion = is_bullish_exhaustion or is_bearish_exhaustion

// For real-time (non-repainting) exhaustion, we flag when extreme volume appears
// Traders can watch for reversal in next bars
is_exhaustion_warning = is_extreme_volume and not is_exhaustion[1]

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TAPE BEHAVIOR DETECTION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// === AGGRESSIVE BUYING/SELLING (Initiative Orders) ===
is_aggressive_buy = show_aggressive and
                     candle_direction == 1 and
                     initiative_score > initiative_threshold and
                     volume_ratio > high_volume_threshold and
                     close_position > 0.7  // Close near high

is_aggressive_sell = show_aggressive and
                      candle_direction == -1 and
                      initiative_score > initiative_threshold and
                      volume_ratio > high_volume_threshold and
                      close_position < 0.3  // Close near low

// === ABSORPTION DETECTION ===
// High volume but narrow range = Smart Money absorbing orders
is_absorption = show_absorption and
                 absorption_normalized > absorption_sensitivity and
                 volume_ratio > high_volume_threshold

// Confirm absorption over multiple bars for stronger signal
absorption_count = 0
for i = 0 to absorption_lookback - 1
    if absorption_normalized[i] > absorption_sensitivity and volume_ratio[i] > high_volume_threshold
        absorption_count := absorption_count + 1

is_strong_absorption = is_absorption and absorption_count >= 2

// === EXHAUSTION ===
show_exhaustion_signal = show_exhaustion and is_exhaustion_warning

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SIGNAL PRIORITIZATION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// When multiple signals occur on same bar, show only the most important one
// Priority: Exhaustion > Aggressive Orders > Absorption

// Determine primary signal for this bar
signal_priority = show_exhaustion_signal ? 4 :
                  is_aggressive_sell ? 3 :
                  is_aggressive_buy ? 2 :
                  is_strong_absorption ? 1 : 0

// Show only the highest priority signal
show_exhaustion_only = signal_priority == 4
show_aggressive_sell_only = signal_priority == 3
show_aggressive_buy_only = signal_priority == 2
show_absorption_only = signal_priority == 1

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CANDLE COLORING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

candle_color = color(na)

if show_candle_colors
    if is_aggressive_buy
        candle_color := color_aggressive_buy
    else if is_aggressive_sell
        candle_color := color_aggressive_sell
    else if is_strong_absorption
        candle_color := color_absorption
    else if show_exhaustion_signal
        candle_color := color_exhaustion

barcolor(candle_color, title="Tape Reading Candle Color")

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// BACKGROUND HIGHLIGHTS (98% transparency - very subtle)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// Only highlight absorption zones (most important for preparation phase)
bgcolor(show_backgrounds and show_absorption_only ? color.new(color.blue, 98) : na, title="Absorption Zone")

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// VOLUME DELTA HISTOGRAM (Optimized: Scaled down, increased transparency)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// Normalize delta for histogram display
delta_normalized_full = volume_delta / ta.highest(math.abs(volume_delta), 50) * 100

// Apply user-defined scaling (default 35% of full size)
delta_normalized = delta_normalized_full * histogram_scale

// Calculate SMA of delta for trend overlay
delta_sma = ta.sma(delta_normalized, histogram_sma_length)

// Apply transparency to histogram colors
histogram_color_buy = color.new(color_delta_buy, histogram_transparency)
histogram_color_sell = color.new(color_delta_sell, histogram_transparency)
histogram_color = volume_delta > 0 ? histogram_color_buy : histogram_color_sell

// Plot histogram (scaled and transparent)
plot(show_delta_histogram ? delta_normalized : na,
     title="Volume Delta Histogram",
     style=plot.style_histogram,
     color=histogram_color,
     linewidth=1)

// Plot SMA overlay on histogram (trend line)
plot(show_delta_histogram and show_histogram_sma ? delta_sma : na,
     title="Delta Trend (SMA)",
     color=color_histogram_sma,
     linewidth=2,
     style=plot.style_line)

// Zero reference line (subtle)
hline(0, "Zero Line", color=color.new(color.gray, 70), linestyle=hline.style_dotted)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// LABELS & SIGNALS (Optimized: Smaller size, better positioning, increased transparency)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

show_label_display = signal_display_mode == "Labels Only" or signal_display_mode == "Both"
show_shape_display = signal_display_mode == "Shapes Only" or signal_display_mode == "Both"

// Calculate vertical offset for better positioning (avoid candle overlap)
label_offset_atr = ta.atr(14) * 0.3

// LABELS (only show highest priority signal per bar - with vertical offset)
if show_label_display and show_labels
    // Exhaustion (Highest Priority)
    if show_exhaustion_only
        label.new(bar_index, high + label_offset_atr, "EXH",
                  style=label.style_label_down,
                  color=color.new(color_exhaustion, 20),
                  textcolor=color.white,
                  size=size.small,
                  tooltip="âš ï¸ EXHAUSTION\nVolume: " + str.tostring(volume_ratio, "#.##") + "x\nWatch for reversal")

    // Aggressive Sell (2nd Priority)
    else if show_aggressive_sell_only
        label.new(bar_index, high + label_offset_atr, "SELL",
                  style=label.style_label_down,
                  color=color.new(color_aggressive_sell, 20),
                  textcolor=color.white,
                  size=size.small,
                  tooltip="ğŸ”´ AGGRESSIVE SELL\nScore: " + str.tostring(initiative_score, "#.##") +
                          "\nVol: " + str.tostring(volume_ratio, "#.##") + "x")

    // Aggressive Buy (3rd Priority)
    else if show_aggressive_buy_only
        label.new(bar_index, low - label_offset_atr, "BUY",
                  style=label.style_label_up,
                  color=color.new(color_aggressive_buy, 20),
                  textcolor=color.white,
                  size=size.small,
                  tooltip="ğŸŸ¢ AGGRESSIVE BUY\nScore: " + str.tostring(initiative_score, "#.##") +
                          "\nVol: " + str.tostring(volume_ratio, "#.##") + "x")

    // Absorption (Lowest Priority) - tiny label
    else if show_absorption_only
        label.new(bar_index, high + label_offset_atr, "ABS",
                  style=label.style_label_down,
                  color=color.new(color_absorption, 30),
                  textcolor=color.white,
                  size=size.tiny,
                  tooltip="ğŸ”µ ABSORPTION\nRatio: " + str.tostring(absorption_normalized, "#.##") +
                          "\nSmart Money zone")

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SHAPES (Optimized: Clear icons, proper sizing, no text overlap)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// Exhaustion: X mark (size.normal) - most important signal
plotshape(show_shape_display and show_exhaustion_only and show_exhaustion,
          title="Exhaustion",
          style=shape.xcross,
          location=location.abovebar,
          color=color_exhaustion,
          size=size.normal,
          text="")

// Aggressive Sell: Triangle down (size.small) - clear directional signal
plotshape(show_shape_display and show_aggressive_sell_only and show_aggressive,
          title="Aggressive Sell",
          style=shape.triangledown,
          location=location.abovebar,
          color=color_aggressive_sell,
          size=size.small,
          text="")

// Aggressive Buy: Triangle up (size.small) - clear directional signal
plotshape(show_shape_display and show_aggressive_buy_only and show_aggressive,
          title="Aggressive Buy",
          style=shape.triangleup,
          location=location.belowbar,
          color=color_aggressive_buy,
          size=size.small,
          text="")

// Absorption: Small circle (size.tiny) - subtle preparation signal
plotshape(show_shape_display and show_absorption_only and show_absorption,
          title="Absorption",
          style=shape.circle,
          location=location.abovebar,
          color=color_absorption,
          size=size.tiny,
          text="")

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ALERT CONDITIONS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

alertcondition(is_aggressive_buy, title="Aggressive Buying", message="Tape Reading: Aggressive BUY detected - Initiative orders pushing price higher with strong volume")
alertcondition(is_aggressive_sell, title="Aggressive Selling", message="Tape Reading: Aggressive SELL detected - Initiative orders pushing price lower with strong volume")
alertcondition(is_strong_absorption, title="Absorption Zone", message="Tape Reading: ABSORPTION detected - Smart Money potentially accumulating/distributing")
alertcondition(show_exhaustion_signal, title="Exhaustion Warning", message="Tape Reading: EXHAUSTION warning - Extreme volume detected, watch for reversal")

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TABLE: COMPACT METRICS (Optimized: 4 critical metrics, 90% transparency, smaller size)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

if show_metrics_table and barstate.islast
    // Compact table: 2 columns x 5 rows (header + 4 metrics)
    var table metrics_table = table.new(position.top_right, 2, 5, border_width=1)

    // Header (90% transparent background)
    table.cell(metrics_table, 0, 0, "Metric", bgcolor=color.new(color.gray, 90), text_color=color.white, text_size=size.tiny)
    table.cell(metrics_table, 1, 0, "Value", bgcolor=color.new(color.gray, 90), text_color=color.white, text_size=size.tiny)

    // 1. Volume Ratio (most important - shows if high volume)
    table.cell(metrics_table, 0, 1, "Vol Ratio", text_size=size.tiny, bgcolor=color.new(color.gray, 95))
    vol_bg = volume_ratio > high_volume_threshold ? color.new(color.green, 85) : color.new(color.gray, 95)
    table.cell(metrics_table, 1, 1, str.tostring(volume_ratio, "#.#") + "x", bgcolor=vol_bg, text_size=size.tiny)

    // 2. Initiative Score (shows aggressive orders)
    table.cell(metrics_table, 0, 2, "Initiative", text_size=size.tiny, bgcolor=color.new(color.gray, 95))
    init_bg = initiative_score > initiative_threshold ? color.new(color.yellow, 85) : color.new(color.gray, 95)
    table.cell(metrics_table, 1, 2, str.tostring(initiative_score, "#.#"), bgcolor=init_bg, text_size=size.tiny)

    // 3. Tape State (current signal)
    tape_state = show_exhaustion_signal ? "EXHAUST" : is_aggressive_buy ? "BUY" : is_aggressive_sell ? "SELL" : is_strong_absorption ? "ABSORB" : "NEUTRAL"
    state_color = show_exhaustion_signal ? color.new(color.orange, 85) : is_aggressive_buy ? color.new(color.green, 85) : is_aggressive_sell ? color.new(color.red, 85) : is_strong_absorption ? color.new(color.blue, 85) : color.new(color.gray, 95)
    table.cell(metrics_table, 0, 3, "State", text_size=size.tiny, bgcolor=color.new(color.gray, 95))
    table.cell(metrics_table, 1, 3, tape_state, bgcolor=state_color, text_size=size.tiny)

    // 4. Delta Direction (simplified: BUY/SELL pressure)
    delta_dir = volume_delta > 0 ? "BUY +" : "SELL -"
    delta_bg = volume_delta > 0 ? color.new(color.green, 85) : color.new(color.red, 85)
    table.cell(metrics_table, 0, 4, "Delta", text_size=size.tiny, bgcolor=color.new(color.gray, 95))
    table.cell(metrics_table, 1, 4, delta_dir, bgcolor=delta_bg, text_size=size.tiny)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// EXPLANATION & USAGE NOTES (visible in indicator info)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// HOW TO USE THIS INDICATOR:
//
// 1. AGGRESSIVE ORDERS (Green/Red Labels: BUY/SELL)
//    - Initiative orders from Smart Money or strong participants
//    - Look for: Strong candle body + High volume + Close near high/low
//    - Trading: Follow the direction until exhaustion signals appear
//
// 2. ABSORPTION ZONES (Blue Labels: ABS)
//    - Smart Money accumulating (before uptrend) or distributing (before downtrend)
//    - Look for: High volume but narrow price range (price not moving despite volume)
//    - Trading: Prepare for breakout in the direction of the eventual move
//    - Best used in consolidation zones
//
// 3. EXHAUSTION (Orange Labels: EXH)
//    - Climax volume indicating the move is complete
//    - Look for: Extreme volume (3x+ average) followed by reversal
//    - Trading: Consider taking profits or reversing position
//
// 4. VOLUME DELTA HISTOGRAM (Lower Pane)
//    - Positive (green) = Net buying pressure
//    - Negative (red) = Net selling pressure
//    - Divergences with price can signal reversals
//
// 5. CANDLE COLORING
//    - Green candles = Aggressive buying
//    - Red candles = Aggressive selling
//    - Blue candles = Absorption (watch for breakout)
//    - Orange candles = Exhaustion warning
//
// VALIDATION PROCESS:
// - Test on 12 different charts (3 low TF, 3 medium TF, 3 high TF, 3 markets)
// - Check if absorption zones lead to breakouts
// - Verify exhaustion signals precede reversals
// - Confirm aggressive signals align with strong directional moves
//
// BEST PRACTICES:
// - Use on liquid markets with reliable volume data
// - Combine with price action and key levels
// - Absorption works best in ranging markets (preparation phase)
// - Aggressive signals work best in trending markets (momentum phase)
// - Avoid choppy/low-volume periods
//
// LIMITATIONS:
// - TradingView doesn't provide real delta, so we estimate it
// - Works best on timeframes 1m to Daily
// - Requires sufficient volume data (avoid illiquid assets)
// - Not designed for fully automated trading (discretionary tool)
