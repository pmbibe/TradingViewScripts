// This Pine Script™ code is subject to the terms of the Mozilla Public License 2.0 at https://mozilla.org/MPL/2.0/
// © pmbibe

//@version=6
indicator("Adaptive Compression Zone Breakout Detector v2.0", shorttitle="CompressionZone", overlay=true, max_boxes_count=500, max_lines_count=500, max_labels_count=500)

// ══════════════════════════════════════════════════════════════════════════════
// INPUTS
// ══════════════════════════════════════════════════════════════════════════════

// Core Parameters
compression_length = input.int(15, "Compression Length", minval=5, maxval=50, tooltip="Minimum bars for valid compression zone")
atr_period = input.int(14, "ATR Period", minval=5, maxval=50, tooltip="Period for ATR calculation")
range_atr_mult = input.float(1.5, "Range ATR Multiplier", minval=0.5, maxval=3.0, step=0.1, tooltip="Zone width <= ATR * this multiplier")

// Volume Confirmation
volume_ma_length = input.int(20, "Volume MA Length", minval=5, maxval=50)
volume_spike_min = input.float(2.0, "Min Volume Spike", minval=1.0, maxval=5.0, step=0.1, tooltip="Minimum volume ratio for confirmation")
volume_spike_strong = input.float(4.0, "Strong Volume Spike", minval=2.0, maxval=10.0, step=0.5, tooltip="Volume ratio for strong signal")

// Momentum Filter
rsi_period = input.int(14, "RSI Period", minval=5, maxval=30)
rsi_ob = input.int(70, "RSI Overbought", minval=60, maxval=90, tooltip="Filter long entries above this level")
rsi_os = input.int(30, "RSI Oversold", minval=10, maxval=40, tooltip="Filter short entries below this level")

// Breakout Confirmation
close_outside_bars = input.int(2, "Close Outside Bars", minval=1, maxval=5, tooltip="Number of bars closing outside zone to confirm")
pullback_allowed = input.bool(true, "Allow Retest Entry", tooltip="Enable secondary entry on zone retest")

// Risk Management
atr_sl_mult = input.float(1.5, "ATR SL Multiplier", minval=0.5, maxval=3.0, step=0.1, tooltip="Stop loss = ATR * this multiplier")
rr_ratio = input.float(2.0, "Risk:Reward Ratio", minval=1.0, maxval=5.0, step=0.5, tooltip="Take profit based on R:R ratio")

// Edge Case Filters
signal_cooldown = input.int(5, "Signal Cooldown (bars)", minval=1, maxval=20, tooltip="Minimum bars between signals")
max_compression_bars = input.int(50, "Max Compression Bars", minval=30, maxval=100, tooltip="Reset zone if exceeds this")
min_body_ratio = input.float(0.3, "Min Body Ratio", minval=0.1, maxval=0.5, step=0.05, tooltip="Filter doji/spinning tops")

// Visual Settings
show_zones = input.bool(true, "Show Compression Zones", group="Visualization")
show_sl_tp = input.bool(true, "Show SL/TP Lines", group="Visualization")
show_dashboard = input.bool(true, "Show Dashboard", group="Visualization")
show_labels = input.bool(true, "Show Signal Labels", group="Visualization")

// ══════════════════════════════════════════════════════════════════════════════
// CALCULATIONS
// ══════════════════════════════════════════════════════════════════════════════

// Step 1: Dynamic Range Threshold
atr = ta.atr(atr_period)
atr_pct = atr / close * 100
dynamic_range_threshold = atr_pct * range_atr_mult

// Step 2: Compression Zone Detection
highest_N = ta.highest(high, compression_length)
lowest_N = ta.lowest(low, compression_length)
zone_mid = (highest_N + lowest_N) / 2

// Calculate actual range percentage
range_pct = (highest_N - lowest_N) / lowest_N * 100

// Compression detection with adaptive threshold
is_tight_range = range_pct < dynamic_range_threshold

// Count bars in compression
var int compression_bars = 0
if is_tight_range
    compression_bars := compression_bars + 1
else
    compression_bars := 0

// Reset if zone is too old (stale zone)
if compression_bars > max_compression_bars
    compression_bars := 0

// Valid compression zone (sufficient length)
is_valid_compression = compression_bars >= compression_length

// Step 3: Volume Analysis
volume_sma = ta.sma(volume, volume_ma_length)
volume_ratio = volume / volume_sma

// Volume trend in compression (accumulation/distribution)
vol_in_zone = ta.sma(volume, compression_length)
vol_before_zone = ta.sma(volume[compression_length], compression_length)
volume_building = vol_in_zone > vol_before_zone * 1.2

// Spike detection
is_volume_spike = volume_ratio >= volume_spike_min
is_strong_spike = volume_ratio >= volume_spike_strong

// Step 4: Momentum Filter
rsi = ta.rsi(close, rsi_period)
ema_fast = ta.ema(close, 8)
ema_slow = ta.ema(close, 21)

// Momentum alignment
bullish_momentum = ema_fast > ema_slow and rsi > 50 and rsi < rsi_ob
bearish_momentum = ema_fast < ema_slow and rsi < 50 and rsi > rsi_os

// Divergence check (bullish divergence)
price_higher_low = low > ta.lowest(low, compression_length)
rsi_higher_low = rsi > ta.lowest(rsi, compression_length)
bullish_divergence = not price_higher_low and rsi_higher_low

// Step 5: Breakout Detection
// Raw breakout signals - using previous bar's levels to avoid lookahead
raw_breakout_up = close > highest_N[1]
raw_breakdown = close < lowest_N[1]

// Confirmation counter
var int confirm_up = 0
var int confirm_down = 0

if raw_breakout_up and close > highest_N[1]
    confirm_up := confirm_up + 1
else if close < highest_N[1]
    confirm_up := 0

if raw_breakdown and close < lowest_N[1]
    confirm_down := confirm_down + 1
else if close > lowest_N[1]
    confirm_down := 0

// Confirmed breakout (N bars close outside zone)
confirmed_breakout_up = confirm_up >= close_outside_bars
confirmed_breakdown = confirm_down >= close_outside_bars

// Body ratio filter (avoid doji/spinning top fake breakouts)
body_size = math.abs(close - open)
candle_range = high - low
body_ratio = candle_range > 0 ? body_size / candle_range : 0
valid_body = body_ratio >= min_body_ratio

// Gap filter
gap_threshold = atr * 2
has_gap = math.abs(open - close[1]) > gap_threshold

// Minimum bars check
has_enough_data = bar_index >= compression_length + atr_period

// Signal cooldown
var int last_signal_bar = 0
cooldown_ok = bar_index - last_signal_bar >= signal_cooldown

// Full breakout signals with all confirmations
breakout_up_raw = confirmed_breakout_up and
                  is_valid_compression[close_outside_bars] and
                  is_volume_spike and
                  (bullish_momentum or bullish_divergence) and
                  valid_body and
                  not has_gap and
                  has_enough_data and
                  cooldown_ok and
                  rsi < rsi_ob

breakdown_raw = confirmed_breakdown and
                is_valid_compression[close_outside_bars] and
                is_volume_spike and
                bearish_momentum and
                valid_body and
                not has_gap and
                has_enough_data and
                cooldown_ok and
                rsi > rsi_os

// Apply signals and update cooldown
var bool breakout_up = false
var bool breakdown = false

breakout_up := breakout_up_raw
breakdown := breakdown_raw

if breakout_up or breakdown
    last_signal_bar := bar_index

// Step 6: Retest Entry Logic
var float breakout_level_up = na
var float breakout_level_down = na
var int breakout_bar_up = na
var int breakout_bar_down = na

// Store breakout levels
if breakout_up[1] and na(breakout_level_up)
    breakout_level_up := highest_N[close_outside_bars + 1]
    breakout_bar_up := bar_index

if breakdown[1] and na(breakout_level_down)
    breakout_level_down := lowest_N[close_outside_bars + 1]
    breakout_bar_down := bar_index

// Clear stale levels (after 10 bars)
if not na(breakout_level_up) and bar_index - breakout_bar_up > 10
    breakout_level_up := na
    breakout_bar_up := na

if not na(breakout_level_down) and bar_index - breakout_bar_down > 10
    breakout_level_down := na
    breakout_bar_down := na

// Retest signals
retest_long = pullback_allowed and
              not na(breakout_level_up) and
              low <= breakout_level_up and
              close > breakout_level_up and
              bar_index - breakout_bar_up <= 10 and
              bar_index - breakout_bar_up >= 1

retest_short = pullback_allowed and
               not na(breakout_level_down) and
               high >= breakout_level_down and
               close < breakout_level_down and
               bar_index - breakout_bar_down <= 10 and
               bar_index - breakout_bar_down >= 1

// Clear level after retest triggered
if retest_long
    breakout_level_up := na
    breakout_bar_up := na

if retest_short
    breakout_level_down := na
    breakout_bar_down := na

// ══════════════════════════════════════════════════════════════════════════════
// RISK CALCULATIONS
// ══════════════════════════════════════════════════════════════════════════════

// Calculate SL/TP for breakout signals
var float long_sl = na
var float long_tp = na
var float short_sl = na
var float short_tp = na
var string signal_strength = na

// Long breakout
if breakout_up
    long_sl := lowest_N[close_outside_bars] - atr * atr_sl_mult
    long_risk = close - long_sl
    long_tp := close + long_risk * rr_ratio
    signal_strength := is_strong_spike ? "STRONG" : "NORMAL"

// Short breakdown
if breakdown
    short_sl := highest_N[close_outside_bars] + atr * atr_sl_mult
    short_risk = short_sl - close
    short_tp := close - short_risk * rr_ratio
    signal_strength := is_strong_spike ? "STRONG" : "NORMAL"

// Retest SL/TP
var float retest_long_sl = na
var float retest_long_tp = na
var float retest_short_sl = na
var float retest_short_tp = na

if retest_long
    retest_long_sl := breakout_level_up - atr * atr_sl_mult
    retest_risk = close - retest_long_sl
    retest_long_tp := close + retest_risk * rr_ratio

if retest_short
    retest_short_sl := breakout_level_down + atr * atr_sl_mult
    retest_risk = retest_short_sl - close
    retest_short_tp := close - retest_risk * rr_ratio

// ══════════════════════════════════════════════════════════════════════════════
// VISUALIZATION
// ══════════════════════════════════════════════════════════════════════════════

// Zone Drawing
var box zone_box = na
zone_color = volume_building ? color.new(color.yellow, 70) : color.new(color.gray, 80)
zone_border = volume_building ? color.orange : color.gray

if show_zones and is_valid_compression and not is_valid_compression[1]
    zone_box := box.new(bar_index - compression_length, highest_N, bar_index, lowest_N,
                        bgcolor=zone_color, border_color=zone_border, border_width=1)

// Update zone box if still in compression
if show_zones and is_valid_compression and not na(zone_box)
    box.set_right(zone_box, bar_index)
    box.set_top(zone_box, highest_N)
    box.set_bottom(zone_box, lowest_N)
    box.set_bgcolor(zone_box, zone_color)
    box.set_border_color(zone_box, zone_border)

// Clear zone box reference when compression ends
if not is_valid_compression
    zone_box := na

// Breakout Signals
arrow_size_up = is_strong_spike ? size.large : size.normal
arrow_size_down = is_strong_spike ? size.large : size.normal

plotshape(breakout_up, title="Breakout UP", style=shape.triangleup, location=location.belowbar,
          color=color.lime, size=size.normal)
plotshape(breakdown, title="Breakdown", style=shape.triangledown, location=location.abovebar,
          color=color.red, size=size.normal)

// Retest signals
plotshape(retest_long, title="Retest Long", style=shape.circle, location=location.belowbar,
          color=color.new(color.lime, 30), size=size.small)
plotshape(retest_short, title="Retest Short", style=shape.circle, location=location.abovebar,
          color=color.new(color.red, 30), size=size.small)

// Signal Labels
if show_labels and breakout_up
    strength_text = is_strong_spike ? "STRONG" : "NORMAL"
    label_text = "BO UP\nVol:" + str.tostring(volume_ratio, "#.#") + "x\nRange:" + str.tostring(range_pct, "#.#") + "%\n" + strength_text
    label.new(bar_index, low, label_text, style=label.style_label_up, color=color.lime, textcolor=color.black, size=size.small)

if show_labels and breakdown
    strength_text = is_strong_spike ? "STRONG" : "NORMAL"
    label_text = "BD DOWN\nVol:" + str.tostring(volume_ratio, "#.#") + "x\nRange:" + str.tostring(range_pct, "#.#") + "%\n" + strength_text
    label.new(bar_index, high, label_text, style=label.style_label_down, color=color.red, textcolor=color.white, size=size.small)

if show_labels and retest_long
    label.new(bar_index, low, "RETEST\nLONG", style=label.style_label_up, color=color.new(color.lime, 30), textcolor=color.black, size=size.tiny)

if show_labels and retest_short
    label.new(bar_index, high, "RETEST\nSHORT", style=label.style_label_down, color=color.new(color.red, 30), textcolor=color.white, size=size.tiny)

// SL/TP Lines
var line sl_line_long = na
var line tp_line_long = na
var line sl_line_short = na
var line tp_line_short = na

if show_sl_tp and breakout_up
    sl_line_long := line.new(bar_index, long_sl, bar_index + 20, long_sl,
                             color=color.red, style=line.style_dashed, width=2)
    tp_line_long := line.new(bar_index, long_tp, bar_index + 20, long_tp,
                             color=color.green, style=line.style_dashed, width=2)
    label.new(bar_index + 20, long_sl, "SL: " + str.tostring(long_sl, "#.####"), style=label.style_label_left, color=color.red, textcolor=color.white, size=size.tiny)
    label.new(bar_index + 20, long_tp, "TP: " + str.tostring(long_tp, "#.####"), style=label.style_label_left, color=color.green, textcolor=color.white, size=size.tiny)

if show_sl_tp and breakdown
    sl_line_short := line.new(bar_index, short_sl, bar_index + 20, short_sl,
                              color=color.red, style=line.style_dashed, width=2)
    tp_line_short := line.new(bar_index, short_tp, bar_index + 20, short_tp,
                              color=color.green, style=line.style_dashed, width=2)
    label.new(bar_index + 20, short_sl, "SL: " + str.tostring(short_sl, "#.####"), style=label.style_label_left, color=color.red, textcolor=color.white, size=size.tiny)
    label.new(bar_index + 20, short_tp, "TP: " + str.tostring(short_tp, "#.####"), style=label.style_label_left, color=color.green, textcolor=color.white, size=size.tiny)

// Dashboard Table
var table dashboard = table.new(position.top_right, 2, 7, bgcolor=color.new(color.black, 80), border_width=1)

if show_dashboard and barstate.islast
    // Header
    table.cell(dashboard, 0, 0, "COMPRESSION ZONE", text_color=color.white, text_size=size.small, bgcolor=color.new(color.blue, 60))
    table.cell(dashboard, 1, 0, "", bgcolor=color.new(color.blue, 60))

    // Compression Status
    table.cell(dashboard, 0, 1, "Status", text_color=color.white, text_size=size.tiny)
    status_text = is_valid_compression ? "ACTIVE (" + str.tostring(compression_bars) + " bars)" : "NO ZONE"
    status_color = is_valid_compression ? color.lime : color.gray
    table.cell(dashboard, 1, 1, status_text, text_color=status_color, text_size=size.tiny)

    // Range %
    table.cell(dashboard, 0, 2, "Range %", text_color=color.white, text_size=size.tiny)
    range_color = range_pct < dynamic_range_threshold ? color.lime : color.orange
    table.cell(dashboard, 1, 2, str.tostring(range_pct, "#.##") + "% / " + str.tostring(dynamic_range_threshold, "#.##") + "%", text_color=range_color, text_size=size.tiny)

    // Volume Ratio
    table.cell(dashboard, 0, 3, "Vol Ratio", text_color=color.white, text_size=size.tiny)
    vol_color = is_strong_spike ? color.lime : is_volume_spike ? color.yellow : color.gray
    table.cell(dashboard, 1, 3, str.tostring(volume_ratio, "#.#") + "x", text_color=vol_color, text_size=size.tiny)

    // RSI
    table.cell(dashboard, 0, 4, "RSI", text_color=color.white, text_size=size.tiny)
    rsi_color = rsi > rsi_ob ? color.red : rsi < rsi_os ? color.green : color.white
    table.cell(dashboard, 1, 4, str.tostring(rsi, "#"), text_color=rsi_color, text_size=size.tiny)

    // Momentum
    table.cell(dashboard, 0, 5, "Momentum", text_color=color.white, text_size=size.tiny)
    mom_text = bullish_momentum ? "BULL" : bearish_momentum ? "BEAR" : "NEUTRAL"
    mom_color = bullish_momentum ? color.lime : bearish_momentum ? color.red : color.gray
    table.cell(dashboard, 1, 5, mom_text, text_color=mom_color, text_size=size.tiny)

    // Volume Building
    table.cell(dashboard, 0, 6, "Vol Building", text_color=color.white, text_size=size.tiny)
    vb_text = volume_building ? "YES" : "NO"
    vb_color = volume_building ? color.yellow : color.gray
    table.cell(dashboard, 1, 6, vb_text, text_color=vb_color, text_size=size.tiny)

// ══════════════════════════════════════════════════════════════════════════════
// ALERTS
// ══════════════════════════════════════════════════════════════════════════════

// Breakout Alerts - Using const strings for Pine Script v6 compatibility
alertcondition(breakout_up, title="Breakout UP",
    message="BREAKOUT UP - Check chart for details: Volume spike detected, compression zone breakout confirmed")

alertcondition(breakdown, title="Breakdown",
    message="BREAKDOWN - Check chart for details: Volume spike detected, compression zone breakdown confirmed")

// Early Warning Alerts
alertcondition(is_valid_compression and not is_valid_compression[1],
    title="Zone Forming",
    message="COMPRESSION ZONE FORMING - Watch for potential breakout")

alertcondition(is_valid_compression and volume_building and volume_ratio > 1.5,
    title="Volume Building",
    message="VOLUME ACCUMULATING IN COMPRESSION - Breakout may be imminent")

// Retest Alerts
alertcondition(retest_long, title="Retest Long",
    message="RETEST ENTRY LONG - Price retesting breakout zone support")

alertcondition(retest_short, title="Retest Short",
    message="RETEST ENTRY SHORT - Price retesting breakdown zone resistance")

// ══════════════════════════════════════════════════════════════════════════════
// PLOT DATA FOR EXTERNAL USE
// ══════════════════════════════════════════════════════════════════════════════

// Plot hidden values for strategy integration
plot(is_valid_compression ? 1 : 0, title="Compression Active", display=display.none)
plot(range_pct, title="Range %", display=display.none)
plot(volume_ratio, title="Volume Ratio", display=display.none)
plot(rsi, title="RSI", display=display.none)
plot(breakout_up ? 1 : 0, title="Breakout UP Signal", display=display.none)
plot(breakdown ? 1 : 0, title="Breakdown Signal", display=display.none)
plot(retest_long ? 1 : 0, title="Retest Long Signal", display=display.none)
plot(retest_short ? 1 : 0, title="Retest Short Signal", display=display.none)
plot(long_sl, title="Long SL", display=display.none)
plot(long_tp, title="Long TP", display=display.none)
plot(short_sl, title="Short SL", display=display.none)
plot(short_tp, title="Short TP", display=display.none)
