// This Pine Script™ code is subject to the terms of the Mozilla Public License 2.0 at https://mozilla.org/MPL/2.0/
// © pmbibe

//@version=6
indicator("Compression Zone Breakout Detector v2.0", shorttitle="CompressionZone", overlay=true, max_boxes_count=500, max_lines_count=500, max_labels_count=500)

// ══════════════════════════════════════════════════════════════════════════════
// INPUTS
// ══════════════════════════════════════════════════════════════════════════════

// Zone Detection
compression_length = input.int(15, "Compression Length", minval=5, maxval=50, tooltip="Minimum bars to form valid compression zone", group="Zone Detection")
atr_period = input.int(14, "ATR Period", minval=5, maxval=50, tooltip="Period for dynamic range threshold calculation", group="Zone Detection")
range_atr_mult = input.float(1.5, "Range ATR Multiplier", minval=0.5, maxval=3.0, step=0.1, tooltip="Zone width <= ATR * this multiplier", group="Zone Detection")

// Volume
volume_ma_length = input.int(20, "Volume MA Length", minval=5, maxval=50, group="Volume")
volume_spike_mult = input.float(2.5, "Volume Spike Multiplier", minval=1.5, maxval=5.0, step=0.1, tooltip="Volume ratio required for confirmation", group="Volume")

// Breakout Confirmation
confirm_bars = input.int(2, "Confirmation Bars", minval=1, maxval=5, tooltip="Number of bars closing outside zone to confirm", group="Breakout Confirmation")
min_body_ratio = input.float(0.4, "Min Body Ratio", minval=0.2, maxval=0.7, step=0.05, tooltip="Filter out doji/wick breakouts", group="Breakout Confirmation")

// Risk Management
sl_atr_mult = input.float(1.0, "SL ATR Multiplier", minval=0.5, maxval=3.0, step=0.1, tooltip="Stop loss = zone edge ± ATR * mult", group="Risk Management")
tp_rr_ratio = input.float(2.0, "Take Profit R:R", minval=1.0, maxval=5.0, step=0.5, tooltip="Take profit based on risk:reward ratio", group="Risk Management")

// History Display
show_history = input.bool(true, "Show Zone History", tooltip="Display historical compression zones", group="History")
max_history_zones = input.int(10, "Max History Zones", minval=1, maxval=50, tooltip="Maximum number of historical zones to display", group="History")
history_days = input.int(7, "History Days", minval=1, maxval=30, tooltip="Show zones from last X days", group="History")

// Edge Case Filters
signal_cooldown = input.int(5, "Signal Cooldown (bars)", minval=1, maxval=20, tooltip="Minimum bars between signals", group="Filters")
max_zone_bars = input.int(50, "Max Zone Bars", minval=30, maxval=100, tooltip="Reset zone if exceeds this length (stale zone)", group="Filters")

// Visual Settings
show_current_zone = input.bool(true, "Show Current Zone", group="Visualization")
show_sl_tp = input.bool(true, "Show SL/TP Lines", group="Visualization")
show_dashboard = input.bool(true, "Show Dashboard", group="Visualization")
show_labels = input.bool(true, "Show Signal Labels", group="Visualization")
show_stats = input.bool(true, "Show Statistics Table", group="Visualization")

// ══════════════════════════════════════════════════════════════════════════════
// CALCULATIONS
// ══════════════════════════════════════════════════════════════════════════════

// Step 1: Dynamic Range Threshold
atr = ta.atr(atr_period)
atr_pct = atr / close * 100
dynamic_threshold = atr_pct * range_atr_mult

// Step 2: Compression Zone Detection
zone_high = ta.highest(high, compression_length)
zone_low = ta.lowest(low, compression_length)
zone_range_pct = (zone_high - zone_low) / zone_low * 100

// Check if currently in compression
is_compressed = zone_range_pct <= dynamic_threshold

// Count bars in compression
var int compression_count = 0
if is_compressed
    compression_count := compression_count + 1
else
    compression_count := 0

// Reset if zone is stale
if compression_count > max_zone_bars
    compression_count := 0

// Valid zone when enough bars accumulated
is_valid_zone = compression_count >= compression_length

// Step 3: Volume Analysis (Pure)
vol_ma = ta.sma(volume, volume_ma_length)
vol_ratio = volume / vol_ma

// Volume accumulation check (volume in zone vs before zone)
vol_in_zone = ta.sma(volume, math.min(compression_count > 0 ? compression_count : 1, compression_length))
vol_before = ta.sma(volume[compression_length], compression_length)
is_accumulating = vol_in_zone > vol_before

// Volume spike detection
is_volume_spike = vol_ratio >= volume_spike_mult
is_strong_spike = vol_ratio >= volume_spike_mult * 1.5

// Step 4: Price Action Breakout
// Raw breakout detection using previous bar's levels
price_break_up = close > zone_high[1]
price_break_down = close < zone_low[1]

// Body ratio filter (reject doji/wick breakouts)
candle_body = math.abs(close - open)
candle_range = high - low
body_ratio = candle_range > 0 ? candle_body / candle_range : 0
is_strong_candle = body_ratio >= min_body_ratio

// Breakout candle size check
breakout_size = candle_body / atr
is_significant_move = breakout_size >= 0.5

// Confirmation counter
var int up_confirms = 0
var int down_confirms = 0

if price_break_up and close > zone_high[1]
    up_confirms := up_confirms + 1
else
    up_confirms := 0

if price_break_down and close < zone_low[1]
    down_confirms := down_confirms + 1
else
    down_confirms := 0

// Minimum data check
has_enough_data = bar_index >= compression_length + atr_period

// Gap filter
gap = math.abs(open - close[1])
has_gap = gap > atr * 1.5

// Weak breakout filter
is_weak_breakout = candle_body < atr * 0.3

// Signal cooldown
var int last_signal_bar = 0
cooldown_ok = bar_index - last_signal_bar >= signal_cooldown

// Step 5: Final Signals
breakout_up_raw = up_confirms >= confirm_bars and
                  is_valid_zone[confirm_bars] and
                  is_volume_spike and
                  is_strong_candle and
                  is_significant_move and
                  not has_gap and
                  not is_weak_breakout and
                  has_enough_data and
                  cooldown_ok

breakdown_raw = down_confirms >= confirm_bars and
                is_valid_zone[confirm_bars] and
                is_volume_spike and
                is_strong_candle and
                is_significant_move and
                not has_gap and
                not is_weak_breakout and
                has_enough_data and
                cooldown_ok

// Apply signals
var bool breakout_up = false
var bool breakdown = false

breakout_up := breakout_up_raw
breakdown := breakdown_raw

if breakout_up or breakdown
    last_signal_bar := bar_index

// Signal strength
signal_strength = is_strong_spike ? "STRONG" : "NORMAL"

// ══════════════════════════════════════════════════════════════════════════════
// RISK CALCULATIONS
// ══════════════════════════════════════════════════════════════════════════════

var float stop_loss = na
var float take_profit = na
var float entry_price = na

// Long breakout
if breakout_up
    entry_price := close
    stop_loss := zone_low[confirm_bars] - atr * sl_atr_mult
    risk = entry_price - stop_loss
    take_profit := entry_price + risk * tp_rr_ratio

// Short breakdown
if breakdown
    entry_price := close
    stop_loss := zone_high[confirm_bars] + atr * sl_atr_mult
    risk = stop_loss - entry_price
    take_profit := entry_price - risk * tp_rr_ratio

// ══════════════════════════════════════════════════════════════════════════════
// ZONE HISTORY TRACKING
// ══════════════════════════════════════════════════════════════════════════════

// Arrays to store zone history
var array<box> zone_history = array.new<box>()
var array<int> zone_bar_start = array.new<int>()
var array<int> zone_bar_end = array.new<int>()
var array<float> zone_high_hist = array.new<float>()
var array<float> zone_low_hist = array.new<float>()
var array<string> zone_result = array.new<string>()

// Track current zone state
var bool was_in_zone = false
var int zone_start_bar = 0
var float current_zone_high = na
var float current_zone_low = na

// Detect new zone forming
if is_valid_zone and not was_in_zone
    zone_start_bar := bar_index - compression_length
    current_zone_high := zone_high
    current_zone_low := zone_low
    was_in_zone := true

// Update zone boundaries while in zone
if was_in_zone and is_valid_zone
    current_zone_high := zone_high
    current_zone_low := zone_low

// Detect zone end (breakout or invalidation)
zone_ended = was_in_zone and (breakout_up or breakdown or (not is_compressed and not is_valid_zone))

if zone_ended
    // Determine result
    result = breakout_up ? "BREAKOUT_UP" : breakdown ? "BREAKDOWN" : "FAILED"

    // Save to history if enabled
    if show_history
        // Determine colors based on result
        zone_color = result == "BREAKOUT_UP" ? color.new(color.green, 85) :
                     result == "BREAKDOWN" ? color.new(color.red, 85) :
                     color.new(color.gray, 90)

        border_color = result == "BREAKOUT_UP" ? color.green :
                       result == "BREAKDOWN" ? color.red :
                       color.gray

        // Create history box
        hist_box = box.new(zone_start_bar, current_zone_high, bar_index, current_zone_low,
                          bgcolor=zone_color, border_color=border_color, border_width=1)

        // Store in arrays
        array.push(zone_history, hist_box)
        array.push(zone_bar_start, zone_start_bar)
        array.push(zone_bar_end, bar_index)
        array.push(zone_high_hist, current_zone_high)
        array.push(zone_low_hist, current_zone_low)
        array.push(zone_result, result)

        // Limit history size
        if array.size(zone_history) > max_history_zones
            old_box = array.shift(zone_history)
            box.delete(old_box)
            array.shift(zone_bar_start)
            array.shift(zone_bar_end)
            array.shift(zone_high_hist)
            array.shift(zone_low_hist)
            array.shift(zone_result)

    // Reset tracking
    was_in_zone := false
    current_zone_high := na
    current_zone_low := na

// Cleanup old zones based on history_days
bars_per_day = timeframe.isintraday ? math.round(24 * 60 / timeframe.multiplier) : 1
max_history_bars = history_days * bars_per_day

if show_history and array.size(zone_history) > 0
    for i = array.size(zone_history) - 1 to 0
        if i < array.size(zone_bar_end)
            zone_end_bar = array.get(zone_bar_end, i)
            if bar_index - zone_end_bar > max_history_bars
                old_box = array.get(zone_history, i)
                box.delete(old_box)
                array.remove(zone_history, i)
                array.remove(zone_bar_start, i)
                array.remove(zone_bar_end, i)
                array.remove(zone_high_hist, i)
                array.remove(zone_low_hist, i)
                array.remove(zone_result, i)

// ══════════════════════════════════════════════════════════════════════════════
// VISUALIZATION
// ══════════════════════════════════════════════════════════════════════════════

// Current Active Zone Box
var box current_box = na
active_zone_color = is_accumulating ? color.new(color.yellow, 75) : color.new(color.orange, 80)
active_border = is_accumulating ? color.yellow : color.orange

if show_current_zone
    if is_valid_zone and not is_valid_zone[1]
        // New zone starting
        current_box := box.new(bar_index - compression_count, zone_high, bar_index, zone_low,
                              bgcolor=active_zone_color, border_color=active_border, border_width=2)
    else if is_valid_zone and not na(current_box)
        // Update existing zone
        box.set_right(current_box, bar_index)
        box.set_top(current_box, zone_high)
        box.set_bottom(current_box, zone_low)
        box.set_bgcolor(current_box, active_zone_color)
        box.set_border_color(current_box, active_border)
    else if not is_valid_zone and not na(current_box)
        // Zone ended, clear reference (box remains as history)
        current_box := na

// Breakout Signals
plotshape(breakout_up, title="Breakout UP", style=shape.triangleup, location=location.belowbar,
          color=color.lime, size=size.normal)
plotshape(breakdown, title="Breakdown", style=shape.triangledown, location=location.abovebar,
          color=color.red, size=size.normal)

// Signal Labels with details
if show_labels and breakout_up
    strength_text = is_strong_spike ? "STRONG" : "NORMAL"
    label_text = "LONG\nVol: " + str.tostring(vol_ratio, "#.#") + "x\nZone: " + str.tostring(zone_range_pct[confirm_bars], "#.#") + "%\nSL: " + str.tostring(stop_loss, "#.####") + "\nTP: " + str.tostring(take_profit, "#.####")
    label.new(bar_index, low, label_text, style=label.style_label_up, color=color.lime, textcolor=color.black, size=size.small)

if show_labels and breakdown
    strength_text = is_strong_spike ? "STRONG" : "NORMAL"
    label_text = "SHORT\nVol: " + str.tostring(vol_ratio, "#.#") + "x\nZone: " + str.tostring(zone_range_pct[confirm_bars], "#.#") + "%\nSL: " + str.tostring(stop_loss, "#.####") + "\nTP: " + str.tostring(take_profit, "#.####")
    label.new(bar_index, high, label_text, style=label.style_label_down, color=color.red, textcolor=color.white, size=size.small)

// SL/TP Lines
if show_sl_tp and breakout_up
    line.new(bar_index, stop_loss, bar_index + 30, stop_loss,
             color=color.red, style=line.style_dashed, width=1)
    line.new(bar_index, take_profit, bar_index + 30, take_profit,
             color=color.green, style=line.style_dashed, width=1)

if show_sl_tp and breakdown
    line.new(bar_index, stop_loss, bar_index + 30, stop_loss,
             color=color.red, style=line.style_dashed, width=1)
    line.new(bar_index, take_profit, bar_index + 30, take_profit,
             color=color.green, style=line.style_dashed, width=1)

// ══════════════════════════════════════════════════════════════════════════════
// INFO PANEL (Dashboard)
// ══════════════════════════════════════════════════════════════════════════════

var table panel = table.new(position.top_right, 2, 6, bgcolor=color.new(color.black, 80), border_width=1)

if show_dashboard and barstate.islast
    // Header
    table.cell(panel, 0, 0, "COMPRESSION ZONE", text_color=color.white, text_size=size.small, bgcolor=color.new(color.blue, 60))
    table.cell(panel, 1, 0, "", bgcolor=color.new(color.blue, 60))

    // Zone Status
    table.cell(panel, 0, 1, "Status", text_color=color.gray, text_size=size.tiny)
    status_text = is_valid_zone ? "ACTIVE" : "NONE"
    status_color = is_valid_zone ? color.lime : color.gray
    table.cell(panel, 1, 1, status_text, text_color=status_color, text_size=size.tiny)

    // Range
    table.cell(panel, 0, 2, "Range", text_color=color.gray, text_size=size.tiny)
    range_color = zone_range_pct <= dynamic_threshold ? color.lime : color.orange
    table.cell(panel, 1, 2, str.tostring(zone_range_pct, "#.##") + "% / " + str.tostring(dynamic_threshold, "#.##") + "%", text_color=range_color, text_size=size.tiny)

    // Volume
    table.cell(panel, 0, 3, "Volume", text_color=color.gray, text_size=size.tiny)
    vol_color = is_strong_spike ? color.lime : is_volume_spike ? color.yellow : color.white
    table.cell(panel, 1, 3, str.tostring(vol_ratio, "#.#") + "x", text_color=vol_color, text_size=size.tiny)

    // Bars in Zone
    table.cell(panel, 0, 4, "Bars", text_color=color.gray, text_size=size.tiny)
    table.cell(panel, 1, 4, str.tostring(compression_count), text_color=color.white, text_size=size.tiny)

    // Accumulating
    table.cell(panel, 0, 5, "Accumulating", text_color=color.gray, text_size=size.tiny)
    acc_text = is_accumulating ? "YES" : "NO"
    acc_color = is_accumulating ? color.yellow : color.gray
    table.cell(panel, 1, 5, acc_text, text_color=acc_color, text_size=size.tiny)

// ══════════════════════════════════════════════════════════════════════════════
// ZONE STATISTICS TABLE
// ══════════════════════════════════════════════════════════════════════════════

var table stats_table = table.new(position.bottom_right, 2, 5, bgcolor=color.new(color.black, 80), border_width=1)

if show_stats and barstate.islast and show_history
    // Count results
    total_zones = array.size(zone_result)
    breakout_ups = 0
    breakdowns = 0
    failed = 0

    if total_zones > 0
        for i = 0 to total_zones - 1
            r = array.get(zone_result, i)
            if r == "BREAKOUT_UP"
                breakout_ups := breakout_ups + 1
            else if r == "BREAKDOWN"
                breakdowns := breakdowns + 1
            else
                failed := failed + 1

    signal_rate = total_zones > 0 ? (breakout_ups + breakdowns) / total_zones * 100 : 0.0

    // Header
    table.cell(stats_table, 0, 0, "ZONE HISTORY", text_color=color.orange, text_size=size.small, bgcolor=color.new(color.purple, 60))
    table.cell(stats_table, 1, 0, str.tostring(total_zones) + " zones", text_color=color.white, text_size=size.small, bgcolor=color.new(color.purple, 60))

    // Breakout Up count
    table.cell(stats_table, 0, 1, "Breakout Up", text_color=color.gray, text_size=size.tiny)
    table.cell(stats_table, 1, 1, str.tostring(breakout_ups), text_color=color.lime, text_size=size.tiny)

    // Breakdown count
    table.cell(stats_table, 0, 2, "Breakdown", text_color=color.gray, text_size=size.tiny)
    table.cell(stats_table, 1, 2, str.tostring(breakdowns), text_color=color.red, text_size=size.tiny)

    // Failed count
    table.cell(stats_table, 0, 3, "Failed", text_color=color.gray, text_size=size.tiny)
    table.cell(stats_table, 1, 3, str.tostring(failed), text_color=color.gray, text_size=size.tiny)

    // Signal Rate
    table.cell(stats_table, 0, 4, "Signal Rate", text_color=color.gray, text_size=size.tiny)
    rate_color = signal_rate >= 60 ? color.lime : signal_rate >= 40 ? color.yellow : color.red
    table.cell(stats_table, 1, 4, str.tostring(signal_rate, "#.#") + "%", text_color=rate_color, text_size=size.tiny)

// ══════════════════════════════════════════════════════════════════════════════
// ALERTS
// ══════════════════════════════════════════════════════════════════════════════

// Zone forming alert
alertcondition(is_valid_zone and not is_valid_zone[1],
    title="Zone Forming",
    message="COMPRESSION ZONE FORMING - Watch for potential breakout")

// Breakout UP alert
alertcondition(breakout_up,
    title="Breakout UP",
    message="BREAKOUT UP - Volume spike confirmed, compression zone breakout detected")

// Breakdown alert
alertcondition(breakdown,
    title="Breakdown",
    message="BREAKDOWN - Volume spike confirmed, compression zone breakdown detected")

// Volume spike in zone alert
alertcondition(is_valid_zone and is_volume_spike and not breakout_up and not breakdown,
    title="Volume Spike in Zone",
    message="VOLUME SPIKE IN COMPRESSION ZONE - Breakout may be imminent")

// ══════════════════════════════════════════════════════════════════════════════
// PLOT DATA FOR EXTERNAL USE
// ══════════════════════════════════════════════════════════════════════════════

plot(is_valid_zone ? 1 : 0, title="Zone Active", display=display.none)
plot(zone_range_pct, title="Zone Range %", display=display.none)
plot(vol_ratio, title="Volume Ratio", display=display.none)
plot(breakout_up ? 1 : 0, title="Breakout UP", display=display.none)
plot(breakdown ? 1 : 0, title="Breakdown", display=display.none)
plot(stop_loss, title="Stop Loss", display=display.none)
plot(take_profit, title="Take Profit", display=display.none)
