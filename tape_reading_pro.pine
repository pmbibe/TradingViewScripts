// This Pine Script™ code is subject to the terms of the Mozilla Public License 2.0 at https://mozilla.org/MPL/2.0/
// © pmbibe

//@version=6
indicator("Tape Reading Pro - Order Flow Analysis", shorttitle="TapeReadingPro", overlay=true, max_bars_back=500, max_labels_count=500)

// ═══════════════════════════════════════════════════════════════════════════════
// TAPE READING FOUNDATIONS
// ═══════════════════════════════════════════════════════════════════════════════
// This indicator decodes institutional order flow by analyzing:
// 1. PRICE: Movement direction, speed, and tick behavior
// 2. VOLUME: Traded volume, spikes, and absorption patterns
// 3. TIME: Duration at price levels and consolidation periods
//
// Key Tape Behaviors Detected:
// - Aggressive Buying/Selling (Initiative Orders)
// - Absorption (Smart Money Accumulation/Distribution)
// - Exhaustion (Climax Volume & Reversals)
// - Initiative vs Responsive Orders
// - Fake vs Real Breakouts

// ═══════════════════════════════════════════════════════════════════════════════
// USER INPUTS
// ═══════════════════════════════════════════════════════════════════════════════

// === MODULE TOGGLES ===
group_modules = "═══ MODULE TOGGLES ═══"
show_aggressive = input.bool(true, "Show Aggressive Orders", group=group_modules, tooltip="Detect initiative buying/selling with fast price movement and high volume")
show_absorption = input.bool(true, "Show Absorption Zones", group=group_modules, tooltip="Identify areas where Smart Money is accumulating/distributing (high volume, minimal price movement)")
show_exhaustion = input.bool(true, "Show Exhaustion Signals", group=group_modules, tooltip="Detect climax volume followed by reversals")
show_delta_histogram = input.bool(true, "Show Volume Delta Histogram", group=group_modules, tooltip="Display estimated buying/selling pressure")
show_labels = input.bool(true, "Show Event Labels", group=group_modules, tooltip="Display labels for key tape reading events")
show_candle_colors = input.bool(true, "Color Candles by Tape Condition", group=group_modules, tooltip="Override candle colors based on order flow")

// === VOLUME PARAMETERS ===
group_volume = "═══ VOLUME PARAMETERS ═══"
volume_ma_length = input.int(20, "Volume MA Length", minval=5, maxval=100, group=group_volume, tooltip="Period for average volume calculation")
high_volume_threshold = input.float(2.0, "High Volume Threshold", minval=1.0, maxval=5.0, step=0.1, group=group_volume, tooltip="Multiplier of average volume to detect high volume (2.0 = 200% of average)")
extreme_volume_threshold = input.float(3.0, "Extreme Volume Threshold", minval=2.0, maxval=10.0, step=0.5, group=group_volume, tooltip="Multiplier for exhaustion detection (3.0 = 300% of average)")

// === ABSORPTION PARAMETERS ===
group_absorption = "═══ ABSORPTION PARAMETERS ═══"
absorption_sensitivity = input.float(1.5, "Absorption Sensitivity", minval=0.5, maxval=5.0, step=0.1, group=group_absorption, tooltip="Higher values = stricter absorption detection. Measures volume/spread ratio.")
absorption_lookback = input.int(3, "Absorption Lookback", minval=1, maxval=10, group=group_absorption, tooltip="Number of bars to confirm absorption pattern")

// === INITIATIVE PARAMETERS ===
group_initiative = "═══ INITIATIVE PARAMETERS ═══"
initiative_threshold = input.float(1.5, "Initiative Score Threshold", minval=1.0, maxval=3.0, step=0.1, group=group_initiative, tooltip="Minimum score to flag aggressive orders (combines body strength with volume)")
velocity_lookback = input.int(5, "Price Velocity Lookback", minval=3, maxval=20, group=group_initiative, tooltip="Period to measure price movement speed")

// === EXHAUSTION PARAMETERS ===
group_exhaustion = "═══ EXHAUSTION PARAMETERS ═══"
exhaustion_reversal_bars = input.int(3, "Exhaustion Reversal Bars", minval=1, maxval=5, group=group_exhaustion, tooltip="Number of reversal bars after climax volume to confirm exhaustion")

// === ADVANCED TAPE PARAMETERS ===
group_advanced = "═══ ADVANCED TAPE PARAMETERS ═══"
compression_bars = input.int(5, "Compression Detection Bars", minval=3, maxval=15, group=group_advanced, tooltip="Bars to detect price compression before breakout")
breakout_velocity_mult = input.float(1.5, "Breakout Velocity Multiplier", minval=1.0, maxval=3.0, step=0.1, group=group_advanced, tooltip="Minimum velocity multiplier for valid breakout")
time_invalidation_bars = input.int(10, "Time Invalidation Bars", minval=5, maxval=30, group=group_advanced, tooltip="Bars without follow-through = time invalidation")
distribution_volume_mult = input.float(2.5, "Distribution Volume Threshold", minval=1.5, maxval=4.0, step=0.1, group=group_advanced, tooltip="Volume multiplier to detect distribution")

// === VISUAL SETTINGS ===
group_visual = "═══ VISUAL SETTINGS ═══"
color_aggressive_buy = input.color(color.new(color.green, 0), "Aggressive Buy", group=group_visual)
color_aggressive_sell = input.color(color.new(color.red, 0), "Aggressive Sell", group=group_visual)
color_absorption = input.color(color.new(color.blue, 0), "Absorption", group=group_visual)
color_exhaustion = input.color(color.new(color.orange, 0), "Exhaustion", group=group_visual)
color_delta_buy = input.color(color.new(color.lime, 60), "Delta Buy Pressure", group=group_visual)
color_delta_sell = input.color(color.new(color.maroon, 60), "Delta Sell Pressure", group=group_visual)

// ═══════════════════════════════════════════════════════════════════════════════
// CORE TAPE READING CALCULATIONS
// ═══════════════════════════════════════════════════════════════════════════════

// === BASIC METRICS ===
candle_body = math.abs(close - open)
candle_range = high - low
candle_direction = close >= open ? 1 : -1

// Avoid division by zero
candle_range_safe = candle_range == 0 ? 0.0000001 : candle_range

// === VOLUME ANALYSIS ===
volume_ma = ta.sma(volume, volume_ma_length)
volume_ratio = volume_ma == 0 ? 0 : volume / volume_ma

// === VOLUME DELTA ESTIMATION ===
// Since TradingView doesn't have real delta, we estimate it using close position within candle
// Bullish candle closing near high = buying pressure
// Bearish candle closing near low = selling pressure
close_position = (close - low) / candle_range_safe  // 0 to 1, where 1 = close at high
delta_estimate = (close_position - 0.5) * 2 * volume  // -volume to +volume
// Alternative: simple delta based on candle direction
delta_simple = candle_direction * volume

// Combine both methods with weight toward close position
volume_delta = (delta_estimate * 0.7) + (delta_simple * 0.3)

// === PRICE VELOCITY ===
// Measures how fast price is moving (initiative orders move price quickly)
price_change = math.abs(close - close[velocity_lookback])
price_velocity = price_change / velocity_lookback

// === ABSORPTION RATIO ===
// High volume with minimal price movement = absorption
// Formula: Volume / (High - Low)
// Higher ratio = more absorption (lots of volume but price not moving)
absorption_ratio = volume / candle_range_safe

// Normalize absorption ratio by comparing to recent average
absorption_ratio_ma = ta.sma(absorption_ratio, absorption_lookback)
absorption_normalized = absorption_ratio_ma == 0 ? 0 : absorption_ratio / absorption_ratio_ma

// === INITIATIVE SCORE ===
// Combines candle body strength with volume to detect aggressive orders
// Strong body + high volume = initiative orders
body_strength = candle_body / candle_range_safe  // Wicks indicate responsive orders, body indicates initiative
initiative_score = body_strength * volume_ratio

// === EXHAUSTION DETECTION ===
// Extreme volume followed by reversal = exhaustion
is_extreme_volume = volume_ratio >= extreme_volume_threshold

// Check if next bars reverse (for exhaustion confirmation)
// Note: This uses future data for confirmation, but clearly marked as such
is_bullish_exhaustion = is_extreme_volume and candle_direction == 1 and ta.falling(close, exhaustion_reversal_bars)
is_bearish_exhaustion = is_extreme_volume and candle_direction == -1 and ta.rising(close, exhaustion_reversal_bars)
is_exhaustion = is_bullish_exhaustion or is_bearish_exhaustion

// For real-time (non-repainting) exhaustion, we flag when extreme volume appears
// Traders can watch for reversal in next bars
is_exhaustion_warning = is_extreme_volume and not is_exhaustion[1]

// ═══════════════════════════════════════════════════════════════════════════════
// ADVANCED TAPE READING VARIABLES
// ═══════════════════════════════════════════════════════════════════════════════

// === TIME AT PRICE (Accumulation Detection) ===
// Count bars where price stays within a tight range = accumulation zone
price_range_pct = candle_range / close * 100
avg_range_pct = ta.sma(price_range_pct, 20)
is_narrow_range = price_range_pct < avg_range_pct * 0.7
time_at_price = ta.barssince(not is_narrow_range)

// === COMPRESSION TIME (Pre-Breakout Detection) ===
// Measure how long price has been compressing (decreasing volatility)
range_compression = ta.lowest(candle_range, compression_bars) / ta.highest(candle_range, compression_bars)
is_compressing = range_compression < 0.5 and time_at_price >= compression_bars
compression_time = is_compressing ? time_at_price : 0

// === BREAKOUT VELOCITY (Initiative Breakout Detection) ===
// Compare current velocity to average - strong breakout needs high velocity
avg_velocity = ta.sma(price_velocity, 20)
breakout_velocity = avg_velocity > 0 ? price_velocity / avg_velocity : 0
is_breakout_velocity = breakout_velocity > breakout_velocity_mult

// === EXHAUSTION INDEX (Momentum Depletion) ===
// High volume but diminishing price progress = exhaustion
recent_vol_sum = math.sum(volume, 3)
recent_price_move = math.abs(close - close[3])
exhaustion_index = recent_vol_sum > 0 ? recent_price_move / (recent_vol_sum / ta.sma(volume, 20)) : 0
is_momentum_exhaustion = exhaustion_index < 0.3 and volume_ratio > high_volume_threshold

// === DISTRIBUTION FLAG (Smart Money Exit Detection) ===
// High volume + price rejection (long upper wick on up move, long lower wick on down move)
upper_wick = high - math.max(open, close)
lower_wick = math.min(open, close) - low
wick_ratio_up = candle_range > 0 ? upper_wick / candle_range : 0
wick_ratio_down = candle_range > 0 ? lower_wick / candle_range : 0
is_distribution_up = candle_direction == 1 and wick_ratio_up > 0.5 and volume_ratio > distribution_volume_mult
is_distribution_down = candle_direction == -1 and wick_ratio_down > 0.5 and volume_ratio > distribution_volume_mult
distribution_flag = is_distribution_up or is_distribution_down

// === ACCUMULATION SCORE (Smart Money Entry Detection) ===
// Combination: absorption + compression + time at price
accumulation_score = 0.0
accumulation_score := accumulation_score + (is_strong_absorption ? 1.0 : 0.0)
accumulation_score := accumulation_score + (is_compressing ? 1.0 : 0.0)
accumulation_score := accumulation_score + (time_at_price > 3 ? 0.5 : 0.0)
accumulation_score := accumulation_score + (absorption_normalized > absorption_sensitivity * 0.8 ? 0.5 : 0.0)
is_accumulation_zone = accumulation_score >= 2.0

// === OPPOSITE ABSORPTION DETECTION ===
// Detect absorption that opposes current position direction
var float last_absorption_delta = na
if is_strong_absorption
    last_absorption_delta := volume_delta

// ═══════════════════════════════════════════════════════════════════════════════
// TAPE BEHAVIOR DETECTION
// ═══════════════════════════════════════════════════════════════════════════════

// === AGGRESSIVE BUYING/SELLING (Initiative Orders) ===
is_aggressive_buy = show_aggressive and
                     candle_direction == 1 and
                     initiative_score > initiative_threshold and
                     volume_ratio > high_volume_threshold and
                     close_position > 0.7  // Close near high

is_aggressive_sell = show_aggressive and
                      candle_direction == -1 and
                      initiative_score > initiative_threshold and
                      volume_ratio > high_volume_threshold and
                      close_position < 0.3  // Close near low

// === ABSORPTION DETECTION ===
// High volume but narrow range = Smart Money absorbing orders
is_absorption = show_absorption and
                 absorption_normalized > absorption_sensitivity and
                 volume_ratio > high_volume_threshold

// Confirm absorption over multiple bars for stronger signal
absorption_count = 0
for i = 0 to absorption_lookback - 1
    if absorption_normalized[i] > absorption_sensitivity and volume_ratio[i] > high_volume_threshold
        absorption_count := absorption_count + 1

is_strong_absorption = is_absorption and absorption_count >= 2

// === EXHAUSTION ===
show_exhaustion_signal = show_exhaustion and is_exhaustion_warning

// ═══════════════════════════════════════════════════════════════════════════════
// ENTRY MANAGEMENT - TAPE-DERIVED STOP LOSS (NOT PERCENTAGE-BASED)
// ═══════════════════════════════════════════════════════════════════════════════

// === ENTRY MANAGEMENT INPUTS ===
group_entry = "═══ ENTRY MANAGEMENT ═══"
show_entry_management = input.bool(true, "Show Entry Management", group=group_entry, tooltip="Display entry and stop loss levels based on tape reading")
entry_filter = input.string("Smart Money + Breakout", "Entry Filter", options=["Aggressive Only", "Smart Money + Breakout", "Accumulation + Breakout"], group=group_entry, tooltip="Aggressive Only: Original BUY/SELL\nSmart Money + Breakout: Requires accumulation confirmation\nAccumulation + Breakout: Strictest filter")
sl_type = input.string("Hybrid", "Stop Loss Type", options=["Structural", "Volume Failure", "Time Invalidation", "Hybrid"], group=group_entry, tooltip="Structural: Below absorption zone\nVolume Failure: High volume against position\nTime Invalidation: No follow-through\nHybrid: All methods")
sl_lookback = input.int(10, "SL Lookback Bars", minval=5, maxval=30, group=group_entry, tooltip="Bars to look back for structural stop loss")
volume_failure_mult = input.float(2.0, "Volume Failure Threshold", minval=1.5, maxval=4.0, step=0.1, group=group_entry, tooltip="Volume multiplier for failure detection")
show_position_box = input.bool(true, "Show Position Box (Darvas Style)", group=group_entry)
show_historical_entries = input.bool(true, "Show Historical Entry Labels", group=group_entry, tooltip="Keep old entry labels on chart for verification")
color_entry_long = input.color(color.new(color.green, 20), "Long Entry Color", group=group_entry)
color_entry_short = input.color(color.new(color.red, 20), "Short Entry Color", group=group_entry)
color_sl_line = input.color(color.new(color.red, 40), "Stop Loss Color", group=group_entry)

// === TAKE PROFIT INPUTS ===
group_tp = "═══ TAKE PROFIT ═══"
show_tp_management = input.bool(true, "Enable Take Profit", group=group_tp)
tp1_enabled = input.bool(true, "TP1 - Momentum Expansion", group=group_tp, tooltip="Partial exit on momentum exhaustion")
tp1_size_pct = input.float(50.0, "TP1 Size (%)", minval=10.0, maxval=90.0, step=5.0, group=group_tp)
tp2_enabled = input.bool(true, "TP2 - Exhaustion/Distribution", group=group_tp, tooltip="Full exit on exhaustion or distribution signals")
color_tp_line = input.color(color.new(color.lime, 40), "Take Profit Color", group=group_tp)

// === POSITION TRACKING VARIABLES ===
var int position_dir = 0              // 1 = Long, -1 = Short, 0 = Flat
var float entry_price = na
var int entry_bar = na
var float stop_loss = na
var float absorption_zone_low = na
var float absorption_zone_high = na
var int position_count = 0            // Track total positions for labeling
var bool tp1_hit = false              // TP1 triggered
var float tp1_level = na              // TP1 price level (momentum target)
var string exit_reason = na           // Track exit reason for labeling
var float max_favorable = na          // Track max favorable excursion for TP
var float breakout_base = na          // Reference price for breakout
var int bars_since_entry = 0          // For time invalidation

// Current position lines (only for active position)
var line current_entry_line = na
var line current_sl_line = na
var line current_tp1_line = na

// === TRACK ABSORPTION ZONES FOR STRUCTURAL SL ===
var float recent_absorption_low = na
var float recent_absorption_high = na

if is_strong_absorption
    recent_absorption_low := low
    recent_absorption_high := high

// === CALCULATE TAPE-DERIVED STOP LOSS ===
calc_structural_sl_long() =>
    float zone_low = not na(recent_absorption_low) ? recent_absorption_low : ta.lowest(low, sl_lookback)
    float buffer = ta.atr(14) * 0.1
    zone_low - buffer

calc_structural_sl_short() =>
    float zone_high = not na(recent_absorption_high) ? recent_absorption_high : ta.highest(high, sl_lookback)
    float buffer = ta.atr(14) * 0.1
    zone_high + buffer

// ═══════════════════════════════════════════════════════════════════════════════
// POSITION LOGIC - TAPE READING BASED ENTRIES & EXITS
// ═══════════════════════════════════════════════════════════════════════════════

// === SMART MONEY ENTRY FILTERS ===
// Recent accumulation/absorption detection (lookback window)
had_recent_accumulation = ta.barssince(is_accumulation_zone) < 10 or ta.barssince(is_strong_absorption) < 10
had_recent_compression = ta.barssince(is_compressing) < 5

// Entry filter logic based on user selection
valid_long_entry = false
valid_short_entry = false

if entry_filter == "Aggressive Only"
    valid_long_entry := is_aggressive_buy
    valid_short_entry := is_aggressive_sell
else if entry_filter == "Smart Money + Breakout"
    valid_long_entry := is_aggressive_buy and (had_recent_accumulation or is_breakout_velocity)
    valid_short_entry := is_aggressive_sell and (had_recent_accumulation or is_breakout_velocity)
else // "Accumulation + Breakout" - strictest
    valid_long_entry := is_aggressive_buy and had_recent_accumulation and is_breakout_velocity
    valid_short_entry := is_aggressive_sell and had_recent_accumulation and is_breakout_velocity

// Entry invalidation filters (block low-quality entries)
no_exhaustion_nearby = not is_exhaustion_warning and not is_momentum_exhaustion
no_distribution_nearby = not distribution_flag

// Final entry signals
new_long_signal = valid_long_entry and no_exhaustion_nearby and no_distribution_nearby
new_short_signal = valid_short_entry and no_exhaustion_nearby and no_distribution_nearby

// === CALCULATE TP1 LEVEL (Momentum Target) ===
// TP1 = Entry + (Risk * 1.5) where Risk = Entry - Stop Loss
calc_tp1_long() =>
    float risk = entry_price - stop_loss
    entry_price + (risk * 1.5)

calc_tp1_short() =>
    float risk = stop_loss - entry_price
    entry_price - (risk * 1.5)

// === PROCESS NEW LONG SIGNAL ===
if show_entry_management and new_long_signal
    // Delete current position lines (will redraw)
    line.delete(current_entry_line)
    line.delete(current_sl_line)
    line.delete(current_tp1_line)

    // Create historical entry label if enabled (keeps old entries visible)
    if show_historical_entries
        position_count := position_count + 1
        string entry_type = entry_filter == "Aggressive Only" ? "AGG" : had_recent_accumulation ? "SM+BO" : "BO"
        label.new(bar_index, low, "L" + str.tostring(position_count),
                  style=label.style_label_up, color=color_entry_long,
                  textcolor=color.white, size=size.tiny,
                  tooltip="LONG Entry #" + str.tostring(position_count) + " (" + entry_type + ")\nPrice: " + str.tostring(close, format.mintick))

    // Update position state
    position_dir := 1
    entry_price := close
    entry_bar := bar_index
    bars_since_entry := 0
    tp1_hit := false
    max_favorable := close
    breakout_base := not na(recent_absorption_low) ? recent_absorption_low : ta.lowest(low, sl_lookback)
    absorption_zone_low := breakout_base
    stop_loss := calc_structural_sl_long()
    tp1_level := calc_tp1_long()
    exit_reason := na

// === PROCESS NEW SHORT SIGNAL ===
if show_entry_management and new_short_signal
    // Delete current position lines (will redraw)
    line.delete(current_entry_line)
    line.delete(current_sl_line)
    line.delete(current_tp1_line)

    // Create historical entry label if enabled
    if show_historical_entries
        position_count := position_count + 1
        string entry_type = entry_filter == "Aggressive Only" ? "AGG" : had_recent_accumulation ? "SM+BO" : "BO"
        label.new(bar_index, high, "S" + str.tostring(position_count),
                  style=label.style_label_down, color=color_entry_short,
                  textcolor=color.white, size=size.tiny,
                  tooltip="SHORT Entry #" + str.tostring(position_count) + " (" + entry_type + ")\nPrice: " + str.tostring(close, format.mintick))

    // Update position state
    position_dir := -1
    entry_price := close
    entry_bar := bar_index
    bars_since_entry := 0
    tp1_hit := false
    max_favorable := close
    breakout_base := not na(recent_absorption_high) ? recent_absorption_high : ta.highest(high, sl_lookback)
    absorption_zone_high := breakout_base
    stop_loss := calc_structural_sl_short()
    tp1_level := calc_tp1_short()
    exit_reason := na

// === UPDATE BARS SINCE ENTRY ===
if position_dir != 0
    bars_since_entry := bars_since_entry + 1
    // Track max favorable excursion
    if position_dir == 1 and high > max_favorable
        max_favorable := high
    if position_dir == -1 and low < max_favorable
        max_favorable := low

// === CHECK STOP LOSS CONDITIONS ===
volume_delta_estimate = (close - open) * volume
volume_failure_long = position_dir == 1 and not na(entry_price) and close < entry_price and volume_ratio > volume_failure_mult and volume_delta_estimate < 0
volume_failure_short = position_dir == -1 and not na(entry_price) and close > entry_price and volume_ratio > volume_failure_mult and volume_delta_estimate > 0

price_sl_hit_long = position_dir == 1 and not na(stop_loss) and low <= stop_loss
price_sl_hit_short = position_dir == -1 and not na(stop_loss) and high >= stop_loss

// Time invalidation: No follow-through after X bars
time_invalidation_long = position_dir == 1 and bars_since_entry >= time_invalidation_bars and close <= entry_price
time_invalidation_short = position_dir == -1 and bars_since_entry >= time_invalidation_bars and close >= entry_price

stop_triggered = false
string sl_reason = na
if sl_type == "Structural"
    stop_triggered := price_sl_hit_long or price_sl_hit_short
    if stop_triggered
        sl_reason := "SL - STRUCTURAL"
else if sl_type == "Volume Failure"
    stop_triggered := volume_failure_long or volume_failure_short
    if stop_triggered
        sl_reason := "SL - VOL FAILURE"
else if sl_type == "Time Invalidation"
    stop_triggered := time_invalidation_long or time_invalidation_short
    if stop_triggered
        sl_reason := "SL - TIME INVALID"
else  // Hybrid
    if price_sl_hit_long or price_sl_hit_short
        stop_triggered := true
        sl_reason := "SL - STRUCTURAL"
    else if volume_failure_long or volume_failure_short
        stop_triggered := true
        sl_reason := "SL - VOL FAILURE"
    else if time_invalidation_long or time_invalidation_short
        stop_triggered := true
        sl_reason := "SL - TIME INVALID"

// === TAKE PROFIT CONDITIONS ===
// TP1: Price reaches momentum target (Risk * 1.5)
tp1_hit_long = position_dir == 1 and not tp1_hit and not na(tp1_level) and high >= tp1_level
tp1_hit_short = position_dir == -1 and not tp1_hit and not na(tp1_level) and low <= tp1_level
tp1_triggered = show_tp_management and tp1_enabled and (tp1_hit_long or tp1_hit_short)

// TP2 / Exit: Exhaustion or Distribution detected
exit_exhaustion_long = position_dir == 1 and (is_bullish_exhaustion or is_momentum_exhaustion)
exit_exhaustion_short = position_dir == -1 and (is_bearish_exhaustion or is_momentum_exhaustion)
exit_distribution_long = position_dir == 1 and is_distribution_up
exit_distribution_short = position_dir == -1 and is_distribution_down

// Opposite absorption = strong exit signal
exit_opposite_absorption_long = position_dir == 1 and is_strong_absorption and volume_delta < 0
exit_opposite_absorption_short = position_dir == -1 and is_strong_absorption and volume_delta > 0

// Full exit conditions
tp2_triggered = show_tp_management and tp2_enabled and (exit_exhaustion_long or exit_exhaustion_short or exit_distribution_long or exit_distribution_short or exit_opposite_absorption_long or exit_opposite_absorption_short)

string tp_reason = na
if tp1_triggered
    tp_reason := "TP1 - MOMENTUM"
if exit_exhaustion_long or exit_exhaustion_short
    tp_reason := "EXIT - EXHAUSTION"
if exit_distribution_long or exit_distribution_short
    tp_reason := "EXIT - DISTRIBUTION"
if exit_opposite_absorption_long or exit_opposite_absorption_short
    tp_reason := "EXIT - OPP ABSORPTION"

// === PROCESS TP1 HIT ===
if tp1_triggered and not tp1_hit
    tp1_hit := true
    if show_historical_entries
        float label_price = position_dir == 1 ? high : low
        label.new(bar_index, label_price, "TP1",
                  style=position_dir == 1 ? label.style_label_down : label.style_label_up,
                  color=color_tp_line, textcolor=color.white, size=size.tiny,
                  tooltip="TP1 - MOMENTUM (" + str.tostring(tp1_size_pct, "#") + "% partial)\nPrice: " + str.tostring(close, format.mintick))

// === PROCESS TP2 / FULL EXIT ===
if tp2_triggered and position_dir != 0
    if show_historical_entries and not na(tp_reason)
        float label_price = position_dir == 1 ? high : low
        label.new(bar_index, label_price, "EXIT",
                  style=position_dir == 1 ? label.style_label_down : label.style_label_up,
                  color=color_exhaustion, textcolor=color.white, size=size.tiny,
                  tooltip=tp_reason + "\nPrice: " + str.tostring(close, format.mintick))
    exit_reason := tp_reason
    // Reset position
    line.delete(current_entry_line)
    line.delete(current_sl_line)
    line.delete(current_tp1_line)
    position_dir := 0
    entry_price := na
    stop_loss := na
    tp1_level := na
    tp1_hit := false

// === PROCESS STOP LOSS HIT ===
if stop_triggered and position_dir != 0
    if show_historical_entries and not na(sl_reason)
        float label_price = position_dir == 1 ? low : high
        label.new(bar_index, label_price, "SL",
                  style=position_dir == 1 ? label.style_label_up : label.style_label_down,
                  color=color_sl_line, textcolor=color.white, size=size.tiny,
                  tooltip=sl_reason + "\nPrice: " + str.tostring(close, format.mintick))
    exit_reason := sl_reason
    // Reset position
    line.delete(current_entry_line)
    line.delete(current_sl_line)
    line.delete(current_tp1_line)
    position_dir := 0
    entry_price := na
    stop_loss := na
    tp1_level := na
    tp1_hit := false

// === DYNAMIC SL ADJUSTMENT (Trail on new absorption) ===
if position_dir == 1 and is_strong_absorption and low > entry_price
    float new_sl = low - ta.atr(14) * 0.1
    if new_sl > stop_loss
        stop_loss := new_sl

if position_dir == -1 and is_strong_absorption and high < entry_price
    float new_sl = high + ta.atr(14) * 0.1
    if new_sl < stop_loss
        stop_loss := new_sl

// === DRAW CURRENT POSITION LINES ===
if show_entry_management and position_dir != 0 and not na(entry_price) and not na(stop_loss)
    line.delete(current_entry_line)
    line.delete(current_sl_line)
    line.delete(current_tp1_line)

    color line_color = position_dir == 1 ? color_entry_long : color_entry_short
    current_entry_line := line.new(entry_bar, entry_price, bar_index + 3, entry_price, color=line_color, width=2, style=line.style_solid)
    current_sl_line := line.new(entry_bar, stop_loss, bar_index + 3, stop_loss, color=color_sl_line, width=1, style=line.style_dashed)

    // Draw TP1 line if not yet hit
    if show_tp_management and tp1_enabled and not tp1_hit and not na(tp1_level)
        current_tp1_line := line.new(entry_bar, tp1_level, bar_index + 3, tp1_level, color=color_tp_line, width=1, style=line.style_dotted)

// ═══════════════════════════════════════════════════════════════════════════════
// DARVAS BOX STYLE - POSITION INFO BOX (Top Right)
// ═══════════════════════════════════════════════════════════════════════════════

if show_position_box and show_entry_management and barstate.islast
    var table pos_box = table.new(position.top_right, 2, 9, bgcolor=color.new(color.black, 80), border_width=1, border_color=color.gray)

    // Determine colors and status
    color header_bg = position_dir == 1 ? color.new(color.green, 30) : position_dir == -1 ? color.new(color.red, 30) : color.new(color.gray, 30)
    string status_text = position_dir == 1 ? "LONG" : position_dir == -1 ? "SHORT" : "NEUTRAL"
    string tp_status = tp1_hit ? "TP1 HIT" : "FULL"

    // Calculate P&L
    float pnl_value = 0.0
    float pnl_pct = 0.0
    if position_dir != 0 and not na(entry_price) and entry_price != 0
        pnl_value := position_dir == 1 ? close - entry_price : entry_price - close
        pnl_pct := pnl_value / entry_price * 100

    color pnl_color = pnl_pct > 0 ? color.new(color.lime, 20) : pnl_pct < 0 ? color.new(color.red, 20) : color.new(color.gray, 50)

    // Calculate Risk:Reward
    float risk = position_dir == 1 ? entry_price - stop_loss : stop_loss - entry_price
    float current_reward = position_dir == 1 ? close - entry_price : entry_price - close
    float rr_ratio = risk > 0 ? current_reward / risk : 0

    // Row 0: Header
    table.cell(pos_box, 0, 0, "POSITION", bgcolor=header_bg, text_color=color.white, text_size=size.small)
    table.cell(pos_box, 1, 0, status_text + (position_dir != 0 ? " (" + tp_status + ")" : ""), bgcolor=header_bg, text_color=color.white, text_size=size.small)

    // Row 1: Entry Filter
    table.cell(pos_box, 0, 1, "Filter", text_color=color.silver, text_size=size.small)
    table.cell(pos_box, 1, 1, entry_filter, text_color=color.aqua, text_size=size.small)

    // Row 2: Entry Price
    table.cell(pos_box, 0, 2, "Entry", text_color=color.silver, text_size=size.small)
    string entry_text = position_dir != 0 and not na(entry_price) ? str.tostring(entry_price, format.mintick) : "---"
    table.cell(pos_box, 1, 2, entry_text, text_color=color.white, text_size=size.small)

    // Row 3: Current Price
    table.cell(pos_box, 0, 3, "Current", text_color=color.silver, text_size=size.small)
    table.cell(pos_box, 1, 3, str.tostring(close, format.mintick), text_color=color.white, text_size=size.small)

    // Row 4: Stop Loss
    table.cell(pos_box, 0, 4, "Stop (" + sl_type + ")", text_color=color.silver, text_size=size.small)
    string sl_text = position_dir != 0 and not na(stop_loss) ? str.tostring(stop_loss, format.mintick) : "---"
    table.cell(pos_box, 1, 4, sl_text, text_color=color.red, text_size=size.small)

    // Row 5: TP1 Level
    table.cell(pos_box, 0, 5, "TP1 (1.5R)", text_color=color.silver, text_size=size.small)
    string tp1_text = position_dir != 0 and not na(tp1_level) ? str.tostring(tp1_level, format.mintick) : "---"
    color tp1_color = tp1_hit ? color.new(color.lime, 50) : color.lime
    table.cell(pos_box, 1, 5, tp1_text + (tp1_hit ? " (HIT)" : ""), text_color=tp1_color, text_size=size.small)

    // Row 6: P&L
    table.cell(pos_box, 0, 6, "P&L", text_color=color.silver, text_size=size.small)
    string pnl_text = position_dir != 0 ? str.tostring(pnl_pct, "#.##") + "%" : "---"
    table.cell(pos_box, 1, 6, pnl_text, bgcolor=position_dir != 0 ? pnl_color : na, text_color=color.white, text_size=size.small)

    // Row 7: R:R Ratio
    table.cell(pos_box, 0, 7, "R:R", text_color=color.silver, text_size=size.small)
    string rr_text = position_dir != 0 ? str.tostring(rr_ratio, "#.##") + "R" : "---"
    color rr_color = rr_ratio >= 1.5 ? color.new(color.lime, 30) : rr_ratio >= 1.0 ? color.new(color.yellow, 30) : rr_ratio > 0 ? color.new(color.orange, 30) : na
    table.cell(pos_box, 1, 7, rr_text, bgcolor=position_dir != 0 and rr_ratio > 0 ? rr_color : na, text_color=color.white, text_size=size.small)

    // Row 8: Signal / Bars
    table.cell(pos_box, 0, 8, "Bars", text_color=color.silver, text_size=size.small)
    string bars_text = position_dir != 0 ? str.tostring(bars_since_entry) + "/" + str.tostring(time_invalidation_bars) : "---"
    color bars_color = bars_since_entry >= time_invalidation_bars * 0.8 ? color.new(color.orange, 30) : na
    table.cell(pos_box, 1, 8, bars_text, bgcolor=bars_color, text_color=color.white, text_size=size.small)

// ═══════════════════════════════════════════════════════════════════════════════
// CANDLE COLORING
// ═══════════════════════════════════════════════════════════════════════════════

candle_color = color(na)

if show_candle_colors
    if is_aggressive_buy
        candle_color := color_aggressive_buy
    else if is_aggressive_sell
        candle_color := color_aggressive_sell
    else if is_strong_absorption
        candle_color := color_absorption
    else if show_exhaustion_signal
        candle_color := color_exhaustion

barcolor(candle_color, title="Tape Reading Candle Color")

// ═══════════════════════════════════════════════════════════════════════════════
// BACKGROUND HIGHLIGHTS
// ═══════════════════════════════════════════════════════════════════════════════

bgcolor(is_strong_absorption and show_absorption ? color.new(color.blue, 95) : na, title="Absorption Zone")
bgcolor(show_exhaustion_signal and show_exhaustion ? color.new(color.orange, 95) : na, title="Exhaustion Warning")

// ═══════════════════════════════════════════════════════════════════════════════
// VOLUME DELTA HISTOGRAM
// ═══════════════════════════════════════════════════════════════════════════════

// Normalize delta for histogram display
delta_normalized = volume_delta / ta.highest(math.abs(volume_delta), 50) * 100
histogram_color = volume_delta > 0 ? color_delta_buy : color_delta_sell

// Plot only if enabled (use na to hide)
plot(show_delta_histogram ? delta_normalized : na, title="Volume Delta", style=plot.style_histogram, color=histogram_color, linewidth=2)
hline(0, "Zero Line", color=color.gray, linestyle=hline.style_dashed)

// ═══════════════════════════════════════════════════════════════════════════════
// LABELS & SIGNALS
// ═══════════════════════════════════════════════════════════════════════════════

if show_labels
    // Aggressive Buy
    if is_aggressive_buy
        label.new(bar_index, low, "BUY",
                  style=label.style_label_up,
                  color=color_aggressive_buy,
                  textcolor=color.white,
                  size=size.small,
                  tooltip="Aggressive Buying Detected\nInitiative Score: " + str.tostring(initiative_score, "#.##") +
                          "\nVolume Ratio: " + str.tostring(volume_ratio, "#.##"))

    // Aggressive Sell
    if is_aggressive_sell
        label.new(bar_index, high, "SELL",
                  style=label.style_label_down,
                  color=color_aggressive_sell,
                  textcolor=color.white,
                  size=size.small,
                  tooltip="Aggressive Selling Detected\nInitiative Score: " + str.tostring(initiative_score, "#.##") +
                          "\nVolume Ratio: " + str.tostring(volume_ratio, "#.##"))

    // Absorption
    if is_strong_absorption
        label.new(bar_index, high * 1.001, "ABS",
                  style=label.style_label_down,
                  color=color_absorption,
                  textcolor=color.white,
                  size=size.tiny,
                  tooltip="Absorption Detected\nHigh Volume, Narrow Range\nAbsorption Ratio: " + str.tostring(absorption_normalized, "#.##") +
                          "\nSmart Money likely positioning")

    // Exhaustion Warning
    if show_exhaustion_signal
        label.new(bar_index, high * 1.002, "EXH",
                  style=label.style_label_down,
                  color=color_exhaustion,
                  textcolor=color.white,
                  size=size.tiny,
                  tooltip="Exhaustion Warning\nExtreme Volume Detected\nVolume Ratio: " + str.tostring(volume_ratio, "#.##") +
                          "\nWatch for reversal")

// ═══════════════════════════════════════════════════════════════════════════════
// PLOTS FOR ALERTS
// ═══════════════════════════════════════════════════════════════════════════════

plotshape(is_aggressive_buy and show_aggressive, title="Aggressive Buy Signal", style=shape.triangleup, location=location.belowbar, color=color_aggressive_buy, size=size.small)
plotshape(is_aggressive_sell and show_aggressive, title="Aggressive Sell Signal", style=shape.triangledown, location=location.abovebar, color=color_aggressive_sell, size=size.small)
plotshape(is_strong_absorption and show_absorption, title="Absorption Signal", style=shape.circle, location=location.abovebar, color=color_absorption, size=size.tiny)
plotshape(show_exhaustion_signal and show_exhaustion, title="Exhaustion Signal", style=shape.xcross, location=location.abovebar, color=color_exhaustion, size=size.small)

// ═══════════════════════════════════════════════════════════════════════════════
// ALERT CONDITIONS
// ═══════════════════════════════════════════════════════════════════════════════

alertcondition(is_aggressive_buy, title="Aggressive Buying", message="Tape Reading: Aggressive BUY detected - Initiative orders pushing price higher with strong volume")
alertcondition(is_aggressive_sell, title="Aggressive Selling", message="Tape Reading: Aggressive SELL detected - Initiative orders pushing price lower with strong volume")
alertcondition(is_strong_absorption, title="Absorption Zone", message="Tape Reading: ABSORPTION detected - Smart Money potentially accumulating/distributing")
alertcondition(show_exhaustion_signal, title="Exhaustion Warning", message="Tape Reading: EXHAUSTION warning - Extreme volume detected, watch for reversal")

// === POSITION MANAGEMENT ALERTS ===
alertcondition(new_long_signal, title="Entry - LONG", message="ENTRY LONG: Smart Money positioning detected + Initiative breakout")
alertcondition(new_short_signal, title="Entry - SHORT", message="ENTRY SHORT: Smart Money positioning detected + Initiative breakout")
alertcondition(tp1_triggered, title="TP1 Hit", message="TP1 HIT: Momentum target reached (1.5R) - Consider partial exit")
alertcondition(tp2_triggered, title="Exit Signal", message="EXIT SIGNAL: Exhaustion/Distribution detected - Consider full exit")
alertcondition(stop_triggered, title="Stop Loss Hit", message="STOP LOSS: Position invalidated - Exit position")
alertcondition(is_accumulation_zone, title="Accumulation Zone", message="ACCUMULATION: Smart Money positioning detected - Watch for breakout")
alertcondition(distribution_flag, title="Distribution Flag", message="DISTRIBUTION: Smart Money potentially exiting - Watch for reversal")

// ═══════════════════════════════════════════════════════════════════════════════
// TABLE: REAL-TIME METRICS DISPLAY
// ═══════════════════════════════════════════════════════════════════════════════

show_metrics_table = input.bool(false, "Show Metrics Table", group=group_visual, tooltip="Display real-time tape reading metrics in a table")

if show_metrics_table and barstate.islast
    var table metrics_table = table.new(position.bottom_right, 2, 10, border_width=1)

    // Header
    table.cell(metrics_table, 0, 0, "Metric", bgcolor=color.gray, text_color=color.white, text_size=size.small)
    table.cell(metrics_table, 1, 0, "Value", bgcolor=color.gray, text_color=color.white, text_size=size.small)

    // Volume Ratio
    table.cell(metrics_table, 0, 1, "Volume Ratio", text_size=size.small)
    table.cell(metrics_table, 1, 1, str.tostring(volume_ratio, "#.##"),
               bgcolor=volume_ratio > high_volume_threshold ? color.new(color.green, 80) : na, text_size=size.small)

    // Initiative Score
    table.cell(metrics_table, 0, 2, "Initiative Score", text_size=size.small)
    table.cell(metrics_table, 1, 2, str.tostring(initiative_score, "#.##"),
               bgcolor=initiative_score > initiative_threshold ? color.new(color.yellow, 80) : na, text_size=size.small)

    // Absorption Ratio
    table.cell(metrics_table, 0, 3, "Absorption Ratio", text_size=size.small)
    table.cell(metrics_table, 1, 3, str.tostring(absorption_normalized, "#.##"),
               bgcolor=absorption_normalized > absorption_sensitivity ? color.new(color.blue, 80) : na, text_size=size.small)

    // Volume Delta
    table.cell(metrics_table, 0, 4, "Volume Delta", text_size=size.small)
    delta_color = volume_delta > 0 ? color.new(color.green, 80) : color.new(color.red, 80)
    table.cell(metrics_table, 1, 4, str.tostring(volume_delta, "#"), bgcolor=delta_color, text_size=size.small)

    // Breakout Velocity
    table.cell(metrics_table, 0, 5, "Breakout Velocity", text_size=size.small)
    table.cell(metrics_table, 1, 5, str.tostring(breakout_velocity, "#.##"),
               bgcolor=is_breakout_velocity ? color.new(color.lime, 80) : na, text_size=size.small)

    // Accumulation Score
    table.cell(metrics_table, 0, 6, "Accumulation Score", text_size=size.small)
    table.cell(metrics_table, 1, 6, str.tostring(accumulation_score, "#.#"),
               bgcolor=is_accumulation_zone ? color.new(color.purple, 80) : na, text_size=size.small)

    // Exhaustion Index
    table.cell(metrics_table, 0, 7, "Exhaustion Index", text_size=size.small)
    table.cell(metrics_table, 1, 7, str.tostring(exhaustion_index, "#.##"),
               bgcolor=is_momentum_exhaustion ? color.new(color.orange, 80) : na, text_size=size.small)

    // Distribution Flag
    table.cell(metrics_table, 0, 8, "Distribution", text_size=size.small)
    table.cell(metrics_table, 1, 8, distribution_flag ? "YES" : "NO",
               bgcolor=distribution_flag ? color.new(color.red, 80) : na, text_size=size.small)

    // Current Tape State
    tape_state = new_long_signal ? "ENTRY LONG" : new_short_signal ? "ENTRY SHORT" : is_aggressive_buy ? "AGG BUY" : is_aggressive_sell ? "AGG SELL" : is_accumulation_zone ? "ACCUMULATION" : is_strong_absorption ? "ABSORPTION" : distribution_flag ? "DISTRIBUTION" : show_exhaustion_signal ? "EXHAUSTION" : "NEUTRAL"
    state_color = new_long_signal ? color.new(color.green, 50) : new_short_signal ? color.new(color.red, 50) : is_aggressive_buy ? color.new(color.green, 70) : is_aggressive_sell ? color.new(color.red, 70) : is_accumulation_zone ? color.new(color.purple, 70) : is_strong_absorption ? color.new(color.blue, 70) : distribution_flag ? color.new(color.maroon, 70) : show_exhaustion_signal ? color.new(color.orange, 70) : na
    table.cell(metrics_table, 0, 9, "Tape State", text_size=size.small)
    table.cell(metrics_table, 1, 9, tape_state, bgcolor=state_color, text_size=size.small)

// ═══════════════════════════════════════════════════════════════════════════════
// EXPLANATION & USAGE NOTES (visible in indicator info)
// ═══════════════════════════════════════════════════════════════════════════════

// HOW TO USE THIS INDICATOR:
//
// 1. AGGRESSIVE ORDERS (Green/Red Labels: BUY/SELL)
//    - Initiative orders from Smart Money or strong participants
//    - Look for: Strong candle body + High volume + Close near high/low
//    - Trading: Follow the direction until exhaustion signals appear
//
// 2. ABSORPTION ZONES (Blue Labels: ABS)
//    - Smart Money accumulating (before uptrend) or distributing (before downtrend)
//    - Look for: High volume but narrow price range (price not moving despite volume)
//    - Trading: Prepare for breakout in the direction of the eventual move
//    - Best used in consolidation zones
//
// 3. EXHAUSTION (Orange Labels: EXH)
//    - Climax volume indicating the move is complete
//    - Look for: Extreme volume (3x+ average) followed by reversal
//    - Trading: Consider taking profits or reversing position
//
// 4. VOLUME DELTA HISTOGRAM (Lower Pane)
//    - Positive (green) = Net buying pressure
//    - Negative (red) = Net selling pressure
//    - Divergences with price can signal reversals
//
// 5. CANDLE COLORING
//    - Green candles = Aggressive buying
//    - Red candles = Aggressive selling
//    - Blue candles = Absorption (watch for breakout)
//    - Orange candles = Exhaustion warning
//
// ═══════════════════════════════════════════════════════════════════════════════
// POSITION TRADING SYSTEM (Tape Reading Based)
// ═══════════════════════════════════════════════════════════════════════════════
//
// ENTRY FILTERS:
// - "Aggressive Only": Original BUY/SELL signals (no filter)
// - "Smart Money + Breakout": Requires recent accumulation OR breakout velocity
// - "Accumulation + Breakout": Strictest - requires BOTH accumulation AND breakout
//
// ENTRY INVALIDATION:
// - Entries blocked if exhaustion or distribution detected nearby
// - Ensures entries only on clean breakouts from accumulation zones
//
// STOP LOSS TYPES:
// - Structural: Below/above absorption zone (tape-derived)
// - Volume Failure: High volume against position = Smart Money exit
// - Time Invalidation: No follow-through after X bars = weak breakout
// - Hybrid: All three methods combined (recommended)
//
// TAKE PROFIT LOGIC:
// - TP1 (Momentum): 1.5R target - partial exit on momentum expansion
// - TP2 (Full Exit): Triggered by exhaustion, distribution, or opposite absorption
//
// POSITION BOX (Darvas Style):
// - Shows: Position, Entry, Current, Stop, TP1, P&L, R:R, Bars elapsed
// - Color coding: Green = profit, Red = loss, Orange = time warning
//
// ═══════════════════════════════════════════════════════════════════════════════
//
// BEST PRACTICES:
// - Use on liquid markets with reliable volume data
// - Combine with price action and key levels
// - Absorption works best in ranging markets (preparation phase)
// - Aggressive signals work best in trending markets (momentum phase)
// - Avoid choppy/low-volume periods
//
// LIMITATIONS:
// - TradingView doesn't provide real delta, so we estimate it
// - Works best on timeframes 1m to Daily
// - Requires sufficient volume data (avoid illiquid assets)
// - Not designed for fully automated trading (discretionary tool)
