// This source code is subject to the terms of the Mozilla Public License 2.0 at https://mozilla.org/MPL/2.0/
// © Volume Structure Analyzer v1.0

//@version=5
indicator("Volume Structure Analyzer", shorttitle="VSA", overlay=true, max_boxes_count=500, max_lines_count=500, max_labels_count=500)

// ═══════════════════════════════════════════════════════════════════════════════
// DESCRIPTION & USAGE
// ═══════════════════════════════════════════════════════════════════════════════
// This indicator analyzes volume patterns and price structure to identify
// accumulation/distribution zones and generate trading signals based on
// Wyckoff methodology and Volume Price Analysis (VPA).
//
// Features:
// - Volume Climax Detection with visual histogram
// - Accumulation & Distribution Zone Identification
// - Breakout/Breakdown Confirmation
// - Buy/Sell Signal Generation with Confidence Scores
// - Volume-Price Divergence Detection
// - Warning Signals for weak setups
// - Multi-panel display with volume analysis
//
// Author: Pine Script Expert
// Version: 1.0
// Date: 2025-12-15
// ═══════════════════════════════════════════════════════════════════════════════

// ═══════════════════════════════════════════════════════════════════════════════
// USER INPUT PARAMETERS
// ═══════════════════════════════════════════════════════════════════════════════

// Volume Settings
volume_period = input.int(20, "Volume Period", minval=10, maxval=50, group="Volume Settings")
volume_climax_threshold = input.float(2.0, "Volume Climax Threshold", minval=1.5, maxval=3.0, step=0.1, group="Volume Settings")
breakout_volume_mult = input.float(1.5, "Breakout Volume Multiplier", minval=1.2, maxval=2.0, step=0.1, group="Volume Settings")

// Structure Settings
accum_range_mult = input.float(0.5, "Accumulation Range Multiplier", minval=0.3, maxval=1.0, step=0.1, group="Structure Settings")
atr_period = input.int(14, "ATR Period", minval=5, maxval=50, group="Structure Settings")
lookback_period = input.int(10, "Pivot Lookback Period", minval=5, maxval=20, group="Structure Settings")

// Display Options
show_accumulation = input.bool(true, "Show Accumulation Zones", group="Display Options")
show_distribution = input.bool(true, "Show Distribution Zones", group="Display Options")
show_volume_hist = input.bool(true, "Show Volume Histogram", group="Display Options")
show_signals = input.bool(true, "Show Buy/Sell Signals", group="Display Options")
show_divergence = input.bool(true, "Show Divergence Lines", group="Display Options")
show_warnings = input.bool(true, "Show Warning Labels", group="Display Options")

// Alert Settings
alert_on_strong_signals = input.bool(false, "Alert on Strong Signals", group="Alert Settings")

// ═══════════════════════════════════════════════════════════════════════════════
// HELPER FUNCTIONS
// ═══════════════════════════════════════════════════════════════════════════════

// Calculate price change percentage
getPriceChange() =>
    ((close - close[1]) / close[1]) * 100

// Check if candle body is strong (body > threshold% of total range)
isStrongBody(threshold) =>
    candle_range = high - low
    candle_body = math.abs(close - open)
    candle_range > 0 ? (candle_body / candle_range) >= threshold : false

// Calculate upper wick percentage
getUpperWickPct() =>
    candle_range = high - low
    upper_wick = high - math.max(open, close)
    candle_range > 0 ? (upper_wick / candle_range) : 0

// Check if price closed in upper portion of candle
closedInUpperHalf() =>
    candle_range = high - low
    close_position = close - low
    candle_range > 0 ? (close_position / candle_range) >= 0.5 : false

// Calculate volume slope (declining trend)
getVolumeSlope(lookback) =>
    sum_x = 0.0
    sum_y = 0.0
    sum_xy = 0.0
    sum_xx = 0.0

    for i = 0 to lookback - 1
        x = i
        y = volume[i]
        sum_x += x
        sum_y += y
        sum_xy += x * y
        sum_xx += x * x

    n = lookback
    slope = (n * sum_xy - sum_x * sum_y) / (n * sum_xx - sum_x * sum_x)
    slope

// ═══════════════════════════════════════════════════════════════════════════════
// VOLUME ANALYSIS MODULE
// ═══════════════════════════════════════════════════════════════════════════════

// Basic Volume Calculations
vol_sma = ta.sma(volume, volume_period)
vol_fast_ma = ta.sma(volume, 10)
vol_slow_ma = ta.sma(volume, 20)

// Volume Ratio
volume_ratio = vol_sma > 0 ? volume / vol_sma : 0

// Volume Strength Index (VSI)
vsi = (volume / vol_sma) * 100

// Price Change
price_change = getPriceChange()

// Volume Climax Detection
bullish_climax = volume_ratio > volume_climax_threshold and price_change > 3.0
bearish_climax = volume_ratio > volume_climax_threshold and price_change < -3.0

// Volume Trend
volume_trend_bullish = vol_fast_ma > vol_slow_ma
volume_trend_bearish = vol_fast_ma < vol_slow_ma

// Volume declining check
volume_declining = getVolumeSlope(10) < 0

// ═══════════════════════════════════════════════════════════════════════════════
// DIVERGENCE DETECTION MODULE
// ═══════════════════════════════════════════════════════════════════════════════

// Find pivot highs and lows
pivot_high = ta.pivothigh(high, lookback_period, lookback_period)
pivot_low = ta.pivotlow(low, lookback_period, lookback_period)

// Store pivot values
var float last_pivot_high_price = na
var int last_pivot_high_bar = na
var float last_pivot_high_volume = na

var float last_pivot_low_price = na
var int last_pivot_low_bar = na
var float last_pivot_low_volume = na

// Update pivot highs
if not na(pivot_high)
    last_pivot_high_price := high[lookback_period]
    last_pivot_high_bar := bar_index - lookback_period
    last_pivot_high_volume := volume[lookback_period]

// Update pivot lows
if not na(pivot_low)
    last_pivot_low_price := low[lookback_period]
    last_pivot_low_bar := bar_index - lookback_period
    last_pivot_low_volume := volume[lookback_period]

// Detect divergences
var bool bearish_divergence = false
var bool bullish_divergence = false

// Bearish Divergence: Price makes Higher High but Volume makes Lower High
if not na(pivot_high) and not na(last_pivot_high_price)
    current_price_hh = high[lookback_period] > last_pivot_high_price
    current_volume_lh = volume[lookback_period] < last_pivot_high_volume
    bearish_divergence := current_price_hh and current_volume_lh
else
    bearish_divergence := false

// Bullish Divergence: Price makes Lower Low but Volume makes Lower Low
if not na(pivot_low) and not na(last_pivot_low_price)
    current_price_ll = low[lookback_period] < last_pivot_low_price
    current_volume_ll = volume[lookback_period] < last_pivot_low_volume
    bullish_divergence := current_price_ll and current_volume_ll
else
    bullish_divergence := false

// ═══════════════════════════════════════════════════════════════════════════════
// STRUCTURE ANALYSIS MODULE - ACCUMULATION ZONES
// ═══════════════════════════════════════════════════════════════════════════════

// ATR for range calculations
atr = ta.atr(atr_period)

// Accumulation Detection Variables
var int accum_start_bar = na
var float accum_high = na
var float accum_low = na
var bool in_accumulation = false
var int accum_bars = 0

// Check for narrow range (consolidation)
price_range = high - low
narrow_range = price_range < (atr * accum_range_mult)

// Spring pattern detection
spring_detected = false
if volume_ratio > volume_climax_threshold and closedInUpperHalf()
    if low < ta.lowest(low, 20)[1] // Tests previous low
        spring_detected := true

// Accumulation logic
if narrow_range and not in_accumulation
    accum_bars += 1
    if accum_bars == 1
        accum_start_bar := bar_index
        accum_high := high
        accum_low := low
    else
        accum_high := math.max(accum_high, high)
        accum_low := math.min(accum_low, low)

    if accum_bars >= 10
        in_accumulation := true
else if not narrow_range
    accum_bars := 0

// Calculate Accumulation Score
accum_score = 0
if in_accumulation
    if price_range < (atr * accum_range_mult)
        accum_score += 25
    if volume_declining
        accum_score += 25
    if spring_detected
        accum_score += 25
    if bullish_climax
        accum_score += 25

// Check for breakout from accumulation
accum_breakout = false
if in_accumulation and not na(accum_high)
    if close > accum_high and volume > vol_sma * breakout_volume_mult and isStrongBody(0.6)
        accum_breakout := true
        in_accumulation := false
        accum_bars := 0

// ═══════════════════════════════════════════════════════════════════════════════
// STRUCTURE ANALYSIS MODULE - DISTRIBUTION ZONES
// ═══════════════════════════════════════════════════════════════════════════════

// Distribution Detection Variables
var int dist_start_bar = na
var float dist_high = na
var float dist_low = na
var bool in_distribution = false
var float dist_prev_high_volume = na

// Check if in uptrend (for distribution context)
in_uptrend = close > ta.sma(close, 50)

// Failed higher high detection
failed_hh = false
if in_uptrend
    prev_high = ta.highest(high, 50)[1]
    if high >= prev_high * 0.98 and high < prev_high * 1.02 // Near previous high
        failed_hh := true

// Volume declining at high
volume_declining_at_high = false
if not na(last_pivot_high_volume) and not na(pivot_high)
    volume_declining_at_high := volume[lookback_period] < last_pivot_high_volume * 0.8

// Price rejection (large upper wick)
price_rejection = getUpperWickPct() > 0.4

// Distribution conditions
dist_conditions = (failed_hh or price_rejection) and volume_declining_at_high

if dist_conditions and not in_distribution and in_uptrend
    in_distribution := true
    dist_start_bar := bar_index
    dist_high := high
    dist_low := low
    dist_prev_high_volume := volume

if in_distribution
    dist_high := math.max(dist_high, high)
    dist_low := math.min(dist_low, low)

// Calculate Distribution Score
dist_score = 0
if in_distribution
    if failed_hh
        dist_score += 25
    if volume_declining_at_high
        dist_score += 25
    if price_rejection
        dist_score += 25
    if bearish_divergence
        dist_score += 25

// Check for breakdown from distribution
dist_breakdown = false
if in_distribution and not na(dist_low)
    if close < dist_low and volume > vol_sma * breakout_volume_mult and isStrongBody(0.6)
        dist_breakdown := true
        in_distribution := false

// ═══════════════════════════════════════════════════════════════════════════════
// BREAKOUT CONFIRMATION MODULE
// ═══════════════════════════════════════════════════════════════════════════════

// Bullish Breakout Confirmation
bullish_breakout = false
if accum_breakout
    // Additional confirmation: no immediate reversal
    no_reversal = true
    if bar_index > 3
        for i = 1 to 3
            if close[i] < open[i] and math.abs(close[i] - open[i]) > (high[i] - low[i]) * 0.5
                no_reversal := false
                break
    bullish_breakout := no_reversal

// Bearish Breakdown Confirmation
bearish_breakdown = false
if dist_breakdown
    // Additional confirmation: no immediate reversal
    no_reversal = true
    if bar_index > 3
        for i = 1 to 3
            if close[i] > open[i] and math.abs(close[i] - open[i]) > (high[i] - low[i]) * 0.5
                no_reversal := false
                break
    bearish_breakdown := no_reversal

// ═══════════════════════════════════════════════════════════════════════════════
// TRADING SIGNAL MODULE
// ═══════════════════════════════════════════════════════════════════════════════

// BUY Signal Scoring
buy_score = 0
if accum_score > 0
    buy_score += 25  // Accumulation zone identified
if spring_detected
    buy_score += 25  // Spring test completed
if bullish_breakout
    buy_score += 25  // Breakout confirmed
if not bearish_divergence
    buy_score += 25  // No bearish divergence

// SELL Signal Scoring
sell_score = 0
if dist_score > 0
    sell_score += 25  // Distribution zone identified
if bearish_climax and price_rejection
    sell_score += 25  // Volume climax at high + rejection
if bearish_breakdown
    sell_score += 25  // Breakdown confirmed
if bearish_divergence
    sell_score += 25  // Bearish divergence present

// Signal Classification
strong_buy = show_signals and buy_score >= 75
buy_signal = show_signals and buy_score >= 50 and buy_score < 75

strong_sell = show_signals and sell_score >= 75
sell_signal = show_signals and sell_score >= 50 and sell_score < 75

// Warning Signals
weak_breakout = accum_breakout and volume < vol_sma * 1.2 and volume > 0

// Exhaustion detection (volume climax at end of trend)
trend_length = 0
if close > close[1]
    trend_length := ta.barssince(close < close[1])
else if close < close[1]
    trend_length := ta.barssince(close > close[1])

exhaustion = (bullish_climax or bearish_climax) and trend_length > 20

// Consolidation detection (declining ATR)
atr_declining = atr < ta.sma(atr, 5)
consolidation = atr_declining and ta.barssince(not atr_declining) >= 5

// ═══════════════════════════════════════════════════════════════════════════════
// VISUAL PLOTTING - MAIN CHART
// ═══════════════════════════════════════════════════════════════════════════════

// Background Colors for Signals
bg_color = color.new(color.white, 100)
if strong_buy
    bg_color := color.new(color.green, 85)
else if buy_signal
    bg_color := color.new(color.green, 92)
else if strong_sell
    bg_color := color.new(color.red, 85)
else if sell_signal
    bg_color := color.new(color.red, 92)

bgcolor(bg_color, title="Signal Background")

// Accumulation Zones
if show_accumulation and in_accumulation and not na(accum_start_bar)
    box.new(accum_start_bar, accum_high, bar_index, accum_low,
             border_color=color.green, bgcolor=color.new(color.green, 90),
             border_width=2, text="ACCUMULATION\n" + str.tostring(accum_score),
             text_color=color.green, text_size=size.small)

// Distribution Zones
if show_distribution and in_distribution and not na(dist_start_bar)
    box.new(dist_start_bar, dist_high, bar_index, dist_low,
             border_color=color.red, bgcolor=color.new(color.red, 90),
             border_width=2, text="DISTRIBUTION\n" + str.tostring(dist_score),
             text_color=color.red, text_size=size.small)

// Breakout Triangles
plotshape(bullish_breakout, title="Bullish Breakout", location=location.belowbar,
          color=color.green, style=shape.triangleup, size=size.normal)

plotshape(bearish_breakdown, title="Bearish Breakdown", location=location.abovebar,
          color=color.red, style=shape.triangledown, size=size.normal)

// Signal Labels
if strong_buy
    label.new(bar_index, low, "STRONG BUY\n" + str.tostring(buy_score),
              style=label.style_label_up, color=color.new(color.green, 20),
              textcolor=color.white, size=size.normal)

if buy_signal
    label.new(bar_index, low, "BUY\n" + str.tostring(buy_score),
              style=label.style_label_up, color=color.new(color.green, 40),
              textcolor=color.white, size=size.small)

if strong_sell
    label.new(bar_index, high, "STRONG SELL\n" + str.tostring(sell_score),
              style=label.style_label_down, color=color.new(color.red, 20),
              textcolor=color.white, size=size.normal)

if sell_signal
    label.new(bar_index, high, "SELL\n" + str.tostring(sell_score),
              style=label.style_label_down, color=color.new(color.red, 40),
              textcolor=color.white, size=size.small)

// Divergence Labels
if show_divergence and bearish_divergence
    label.new(bar_index - lookback_period, high[lookback_period], "BEAR DIV",
              style=label.style_label_down, color=color.orange,
              textcolor=color.white, size=size.small)

if show_divergence and bullish_divergence
    label.new(bar_index - lookback_period, low[lookback_period], "BULL DIV",
              style=label.style_label_up, color=color.blue,
              textcolor=color.white, size=size.small)

// Warning Labels
if show_warnings and weak_breakout
    label.new(bar_index, high, "WEAK BREAKOUT",
              style=label.style_label_down, color=color.yellow,
              textcolor=color.black, size=size.tiny)

if show_warnings and exhaustion
    label.new(bar_index, high, "EXHAUSTION",
              style=label.style_label_down, color=color.yellow,
              textcolor=color.black, size=size.tiny)

if show_warnings and consolidation
    label.new(bar_index, high, "CONSOLIDATION",
              style=label.style_label_down, color=color.yellow,
              textcolor=color.black, size=size.tiny)

// Signal tracking dots
plot(strong_buy or buy_signal ? low * 0.999 : na, title="Buy Dots",
     color=color.green, style=plot.style_circles, linewidth=2)
plot(strong_sell or sell_signal ? high * 1.001 : na, title="Sell Dots",
     color=color.red, style=plot.style_circles, linewidth=2)

// ═══════════════════════════════════════════════════════════════════════════════
// VISUAL PLOTTING - VOLUME PANEL
// ═══════════════════════════════════════════════════════════════════════════════

// Volume Histogram Color Logic
vol_color = color.gray
if show_volume_hist
    if volume > vol_sma
        if close > open
            vol_color := color.green  // Vol up + Price up
        else
            vol_color := bullish_climax ? color.new(color.lime, 30) : color.new(color.green, 60)  // Vol up + Price down (potential bottom)
    else
        if close < open
            vol_color := color.red  // Vol up + Price down (selling)
        else
            vol_color := bearish_climax ? color.new(color.red, 30) : color.new(color.red, 60)  // Vol up + Price up (potential top)

    // Climax highlights
    if bullish_climax
        vol_color := color.new(color.lime, 0)
    if bearish_climax
        vol_color := color.new(color.red, 0)

// Plot volume histogram
plot(show_volume_hist ? volume : na, title="Volume", color=vol_color,
     style=plot.style_histogram, linewidth=1)

// Volume MA lines
plot(show_volume_hist ? vol_fast_ma : na, title="Fast Vol MA",
     color=color.blue, linewidth=1)
plot(show_volume_hist ? vol_slow_ma : na, title="Slow Vol MA",
     color=color.orange, linewidth=1)

// Threshold line
plot(show_volume_hist ? vol_sma * volume_climax_threshold : na,
     title="Climax Threshold", color=color.gray, linewidth=1, style=plot.style_linebr)

// Volume trend background
vol_bg_color = volume_trend_bullish ? color.new(color.green, 95) : color.new(color.red, 95)
bgcolor(show_volume_hist ? vol_bg_color : na, title="Volume Trend BG")

// ═══════════════════════════════════════════════════════════════════════════════
// INDICATOR PANEL - ADDITIONAL METRICS
// ═══════════════════════════════════════════════════════════════════════════════

// Volume Strength Index (0-300 scale)
plot(vsi, title="VSI", color=color.purple, linewidth=2, display=display.none)

// Accumulation Score (0-100)
plot(accum_score, title="Accumulation Score", color=color.green, linewidth=2, display=display.none)

// Distribution Score (0-100)
plot(dist_score, title="Distribution Score", color=color.red, linewidth=2, display=display.none)

// Overall Signal Strength (-100 to +100)
overall_signal = buy_score - sell_score
plot(overall_signal, title="Overall Signal Strength", color=color.blue, linewidth=2, display=display.none)

// ═══════════════════════════════════════════════════════════════════════════════
// ALERT CONDITIONS
// ═══════════════════════════════════════════════════════════════════════════════

// Strong Buy Signal
alertcondition(strong_buy and alert_on_strong_signals,
               title="Strong Buy Signal",
               message="VSA: Strong Buy Signal Detected (Score: {{plot_0}})")

// Strong Sell Signal
alertcondition(strong_sell and alert_on_strong_signals,
               title="Strong Sell Signal",
               message="VSA: Strong Sell Signal Detected (Score: {{plot_0}})")

// Volume Climax
alertcondition(bullish_climax or bearish_climax,
               title="Volume Climax Detected",
               message="VSA: Volume Climax Detected")

// Accumulation Zone
alertcondition(in_accumulation and accum_bars == 10,
               title="Accumulation Zone Formed",
               message="VSA: Accumulation Zone Formed")

// Distribution Zone
alertcondition(in_distribution and not in_distribution[1],
               title="Distribution Zone Formed",
               message="VSA: Distribution Zone Formed")

// Bullish Breakout
alertcondition(bullish_breakout,
               title="Bullish Breakout Confirmed",
               message="VSA: Bullish Breakout Confirmed")

// Bearish Breakdown
alertcondition(bearish_breakdown,
               title="Bearish Breakdown Confirmed",
               message="VSA: Bearish Breakdown Confirmed")

// ═══════════════════════════════════════════════════════════════════════════════
// END OF INDICATOR
// ═══════════════════════════════════════════════════════════════════════════════
