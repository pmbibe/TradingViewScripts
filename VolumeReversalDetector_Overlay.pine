//@version=5
indicator("Volume Reversal Detector (VRD) - Overlay", overlay=true)

// ============================================================================
// === INPUT PARAMETERS ===
// ============================================================================

volume_ma_length = input.int(20, title="Volume MA Length", minval=5, maxval=50,
     tooltip="Length for calculating Volume Moving Average. Higher values = smoother line.")

spike_threshold = input.float(1.5, title="Spike Threshold", minval=1.0, maxval=3.0, step=0.1,
     tooltip="Minimum volume ratio to volume MA to be considered a spike. Default 1.5x.")

extreme_spike = input.float(2.5, title="Extreme Spike Threshold", minval=1.5, maxval=5.0, step=0.1,
     tooltip="Extreme volume spike threshold for strong reversal signals. Default 2.5x.")

lookback_period = input.int(10, title="Lookback Period", minval=5, maxval=20,
     tooltip="Period to analyze buying/selling pressure and find max volumes.")

top_zone_percent = input.float(0.95, title="Top Zone %", minval=0.90, maxval=0.99, step=0.01,
     tooltip="Percentage of recent high to define top zone. 0.95 = within 5% of high.")

bottom_zone_percent = input.float(1.05, title="Bottom Zone %", minval=1.01, maxval=1.10, step=0.01,
     tooltip="Percentage of recent low to define bottom zone. 1.05 = within 5% of low.")

// ============================================================================
// === VOLUME ANALYSIS ===
// ============================================================================

// Basic volume metrics
volume_ma = ta.sma(volume, volume_ma_length)
volume_ratio = volume / volume_ma
is_spike_volume = volume_ratio >= spike_threshold
is_extreme_volume = volume_ratio >= extreme_spike

// Classify volume by candle direction
is_green_candle = close > open
is_red_candle = close < open
buying_volume = is_green_candle ? volume : 0
selling_volume = is_red_candle ? volume : 0

// ============================================================================
// === PRESSURE ANALYSIS ===
// ============================================================================

// Calculate total buying/selling volume in lookback period
// Using SMA * length to calculate sum (Pine Script v5 compatible)
total_buying_volume = ta.sma(buying_volume, lookback_period) * lookback_period
total_selling_volume = ta.sma(selling_volume, lookback_period) * lookback_period

// Volume pressure ratio
volume_pressure_ratio = total_selling_volume / total_buying_volume

// ============================================================================
// === ZONE DETECTION ===
// ============================================================================

// Find recent high/low
recent_high = ta.highest(high, 20)
recent_low = ta.lowest(low, 20)

// Check if price is in top or bottom zone
at_top_zone = close > (recent_high * top_zone_percent)
at_bottom_zone = close < (recent_low * bottom_zone_percent)

// ============================================================================
// === MAX VOLUME IN LOOKBACK ===
// ============================================================================

// Find maximum green and red volume in lookback period
max_green_volume_in_lookback = ta.highest(is_green_candle ? volume : 0, lookback_period)
max_red_volume_in_lookback = ta.highest(is_red_candle ? volume : 0, lookback_period)

// ============================================================================
// === SIGNAL LOGIC ===
// ============================================================================

// --- SELL SIGNALS ---

// Condition 1: Volume Spike Reversal (strongest)
sell_signal_strong = at_top_zone and is_red_candle and is_extreme_volume and volume > max_green_volume_in_lookback

// Condition 2: Selling Pressure Dominant
sell_warning = at_top_zone and volume_pressure_ratio > 1.5 and is_spike_volume and is_red_candle

// Condition 3: Breakdown Confirmation
breakdown_signal = close < ta.lowest(low[1], 5) and volume_ratio >= 2.0 and is_red_candle

// --- BUY SIGNALS ---

// Condition 1: Volume Breakout
buy_signal_strong = close > ta.highest(high[1], 5) and volume_ratio >= 2.0 and is_green_candle and volume > ta.sma(volume, 20)

// Condition 2: Buying Pressure Dominant
buy_warning = at_bottom_zone and volume_pressure_ratio < 0.67 and is_spike_volume and is_green_candle

// ============================================================================
// === PLOTTING - MAIN CHART (Price Panel) ===
// ============================================================================

// Arrows on candles for strong signals only
plotshape(sell_signal_strong, title="Sell Arrow",
     style=shape.triangledown, location=location.abovebar,
     color=color.red, size=size.small, text="SELL")

plotshape(buy_signal_strong, title="Buy Arrow",
     style=shape.triangleup, location=location.belowbar,
     color=color.lime, size=size.small, text="BUY")

// ============================================================================
// === ALERTS ===
// ============================================================================

alertcondition(sell_signal_strong, title="Sell Signal Strong",
     message="ðŸ”´ SELL SIGNAL: Volume Reversal Detected")

alertcondition(buy_signal_strong, title="Buy Signal Strong",
     message="ðŸŸ¢ BUY SIGNAL: Volume Breakout Detected")

alertcondition(breakdown_signal, title="Breakdown Signal",
     message="ðŸš¨ BREAKDOWN: Strong Selling Pressure")
